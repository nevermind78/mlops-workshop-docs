<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.25">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Workshop MLOps avec Azure - Guide Pratique Étudiant</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="moduleMLOPS_DEPLOY_files/libs/clipboard/clipboard.min.js"></script>
<script src="moduleMLOPS_DEPLOY_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="moduleMLOPS_DEPLOY_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="moduleMLOPS_DEPLOY_files/libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="moduleMLOPS_DEPLOY_files/libs/quarto-html/popper.min.js"></script>
<script src="moduleMLOPS_DEPLOY_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="moduleMLOPS_DEPLOY_files/libs/quarto-html/anchor.min.js"></script>
<link href="moduleMLOPS_DEPLOY_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="moduleMLOPS_DEPLOY_files/libs/quarto-html/quarto-syntax-highlighting-7b89279ff1a6dce999919e0e67d4d9ec.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="moduleMLOPS_DEPLOY_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="moduleMLOPS_DEPLOY_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="moduleMLOPS_DEPLOY_files/libs/bootstrap/bootstrap-0df8dfdce555b5e457e6102d33c50900.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">


</head>

<body class="quarto-light">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article toc-left">
<div id="quarto-sidebar-toc-left" class="sidebar toc-left">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#sec-introduction" id="toc-sec-introduction" class="nav-link active" data-scroll-target="#sec-introduction"><span class="header-section-number">1</span> Introduction</a>
  <ul class="collapse">
  <li><a href="#bienvenue" id="toc-bienvenue" class="nav-link" data-scroll-target="#bienvenue"><span class="header-section-number">1.1</span> Bienvenue !</a></li>
  <li><a href="#sec-objectifs" id="toc-sec-objectifs" class="nav-link" data-scroll-target="#sec-objectifs"><span class="header-section-number">1.2</span> Objectifs d’Apprentissage</a></li>
  <li><a href="#sec-projet" id="toc-sec-projet" class="nav-link" data-scroll-target="#sec-projet"><span class="header-section-number">1.3</span> Le Projet : Bank Churn Prediction</a></li>
  <li><a href="#sec-architecture" id="toc-sec-architecture" class="nav-link" data-scroll-target="#sec-architecture"><span class="header-section-number">1.4</span> Architecture Finale</a></li>
  </ul></li>
  <li><a href="#sec-preparation" id="toc-sec-preparation" class="nav-link" data-scroll-target="#sec-preparation"><span class="header-section-number">2</span> Préparation de l’Environnement</a>
  <ul class="collapse">
  <li><a href="#sec-logiciels" id="toc-sec-logiciels" class="nav-link" data-scroll-target="#sec-logiciels"><span class="header-section-number">2.1</span> Logiciels Requis</a></li>
  <li><a href="#sec-verification" id="toc-sec-verification" class="nav-link" data-scroll-target="#sec-verification"><span class="header-section-number">2.2</span> Vérification de l’Installation</a></li>
  <li><a href="#sec-configuration" id="toc-sec-configuration" class="nav-link" data-scroll-target="#sec-configuration"><span class="header-section-number">2.3</span> Configuration Initiale</a></li>
  </ul></li>
  <li><a href="#sec-module1" id="toc-sec-module1" class="nav-link" data-scroll-target="#sec-module1"><span class="header-section-number">3</span> Module 1 : Entraînement du Modèle</a>
  <ul class="collapse">
  <li><a href="#sec-module1-objectif" id="toc-sec-module1-objectif" class="nav-link" data-scroll-target="#sec-module1-objectif"><span class="header-section-number">3.1</span> Objectif</a></li>
  <li><a href="#sec-module1-preparation" id="toc-sec-module1-preparation" class="nav-link" data-scroll-target="#sec-module1-preparation"><span class="header-section-number">3.2</span> Préparation du Projet</a></li>
  <li><a href="#sec-module1-requirements" id="toc-sec-module1-requirements" class="nav-link" data-scroll-target="#sec-module1-requirements"><span class="header-section-number">3.3</span> Fichier requirements.txt</a></li>
  <li><a href="#sec-module1-dataset" id="toc-sec-module1-dataset" class="nav-link" data-scroll-target="#sec-module1-dataset"><span class="header-section-number">3.4</span> Téléchargement du Dataset</a></li>
  <li><a href="#sec-module1-training" id="toc-sec-module1-training" class="nav-link" data-scroll-target="#sec-module1-training"><span class="header-section-number">3.5</span> Script d’Entraînement</a></li>
  <li><a href="#sec-module1-execution" id="toc-sec-module1-execution" class="nav-link" data-scroll-target="#sec-module1-execution"><span class="header-section-number">3.6</span> Exécution</a></li>
  <li><a href="#sec-module1-checkpoint" id="toc-sec-module1-checkpoint" class="nav-link" data-scroll-target="#sec-module1-checkpoint"><span class="header-section-number">3.7</span> Checkpoint</a></li>
  </ul></li>
  <li><a href="#sec-module2" id="toc-sec-module2" class="nav-link" data-scroll-target="#sec-module2"><span class="header-section-number">4</span> Module 2 : Création de l’API avec FastAPI</a>
  <ul class="collapse">
  <li><a href="#sec-module2-objectif" id="toc-sec-module2-objectif" class="nav-link" data-scroll-target="#sec-module2-objectif"><span class="header-section-number">4.1</span> Objectif</a></li>
  <li><a href="#sec-module2-structure" id="toc-sec-module2-structure" class="nav-link" data-scroll-target="#sec-module2-structure"><span class="header-section-number">4.2</span> Structure du Code API</a></li>
  <li><a href="#sec-module2-models" id="toc-sec-module2-models" class="nav-link" data-scroll-target="#sec-module2-models"><span class="header-section-number">4.3</span> Fichier app/models.py</a></li>
  <li><a href="#sec-module2-main" id="toc-sec-module2-main" class="nav-link" data-scroll-target="#sec-module2-main"><span class="header-section-number">4.4</span> Fichier app/main.py</a></li>
  <li><a href="#sec-module2-test" id="toc-sec-module2-test" class="nav-link" data-scroll-target="#sec-module2-test"><span class="header-section-number">4.5</span> Test Local de l’API</a></li>
  <li><a href="#sec-module2-docs" id="toc-sec-module2-docs" class="nav-link" data-scroll-target="#sec-module2-docs"><span class="header-section-number">4.6</span> Documentation Interactive</a></li>
  <li><a href="#sec-module2-checkpoint" id="toc-sec-module2-checkpoint" class="nav-link" data-scroll-target="#sec-module2-checkpoint"><span class="header-section-number">4.7</span> Checkpoint</a></li>
  </ul></li>
  <li><a href="#sec-module3" id="toc-sec-module3" class="nav-link" data-scroll-target="#sec-module3"><span class="header-section-number">5</span> Module 3 : Conteneurisation avec Docker</a>
  <ul class="collapse">
  <li><a href="#sec-module3-objectif" id="toc-sec-module3-objectif" class="nav-link" data-scroll-target="#sec-module3-objectif"><span class="header-section-number">5.1</span> Objectif</a></li>
  <li><a href="#sec-module3-dockerfile" id="toc-sec-module3-dockerfile" class="nav-link" data-scroll-target="#sec-module3-dockerfile"><span class="header-section-number">5.2</span> Création du Dockerfile</a></li>
  <li><a href="#sec-module3-dockerignore" id="toc-sec-module3-dockerignore" class="nav-link" data-scroll-target="#sec-module3-dockerignore"><span class="header-section-number">5.3</span> Création du .dockerignore</a></li>
  <li><a href="#sec-module3-build" id="toc-sec-module3-build" class="nav-link" data-scroll-target="#sec-module3-build"><span class="header-section-number">5.4</span> Build de l’Image Docker</a></li>
  <li><a href="#sec-module3-test" id="toc-sec-module3-test" class="nav-link" data-scroll-target="#sec-module3-test"><span class="header-section-number">5.5</span> Test du Conteneur en Local</a></li>
  <li><a href="#sec-module3-commandes" id="toc-sec-module3-commandes" class="nav-link" data-scroll-target="#sec-module3-commandes"><span class="header-section-number">5.6</span> Commandes Docker Utiles</a></li>
  <li><a href="#sec-module3-questions" id="toc-sec-module3-questions" class="nav-link" data-scroll-target="#sec-module3-questions"><span class="header-section-number">5.7</span> Questions de Compréhension</a></li>
  <li><a href="#sec-module3-checkpoint" id="toc-sec-module3-checkpoint" class="nav-link" data-scroll-target="#sec-module3-checkpoint"><span class="header-section-number">5.8</span> Checkpoint</a></li>
  </ul></li>
  <li><a href="#sec-module4" id="toc-sec-module4" class="nav-link" data-scroll-target="#sec-module4"><span class="header-section-number">6</span> Module 4 : Déploiement sur Azure</a>
  <ul class="collapse">
  <li><a href="#sec-module4-objectif" id="toc-sec-module4-objectif" class="nav-link" data-scroll-target="#sec-module4-objectif"><span class="header-section-number">6.1</span> Objectif</a></li>
  <li><a href="#sec-module4-etape1" id="toc-sec-module4-etape1" class="nav-link" data-scroll-target="#sec-module4-etape1"><span class="header-section-number">6.2</span> Étape 1 : Création du Groupe de Ressources</a></li>
  <li><a href="#sec-module4-etape2" id="toc-sec-module4-etape2" class="nav-link" data-scroll-target="#sec-module4-etape2"><span class="header-section-number">6.3</span> Étape 2 : Azure Container Registry (ACR)</a></li>
  <li><a href="#sec-module4-etape3" id="toc-sec-module4-etape3" class="nav-link" data-scroll-target="#sec-module4-etape3"><span class="header-section-number">6.4</span> Étape 3 : Push de l’Image vers ACR</a></li>
  <li><a href="#sec-module4-etape4" id="toc-sec-module4-etape4" class="nav-link" data-scroll-target="#sec-module4-etape4"><span class="header-section-number">6.5</span> Étape 4 : Création de l’Environnement Container Apps</a></li>
  <li><a href="#sec-module4-etape5" id="toc-sec-module4-etape5" class="nav-link" data-scroll-target="#sec-module4-etape5"><span class="header-section-number">6.6</span> Étape 5 : Déploiement de l’Application</a></li>
  <li><a href="#sec-module4-etape6" id="toc-sec-module4-etape6" class="nav-link" data-scroll-target="#sec-module4-etape6"><span class="header-section-number">6.7</span> Étape 6 : Récupérer l’URL Publique</a></li>
  <li><a href="#sec-module4-etape7" id="toc-sec-module4-etape7" class="nav-link" data-scroll-target="#sec-module4-etape7"><span class="header-section-number">6.8</span> Étape 7 : Test de l’API en Production</a></li>
  <li><a href="#sec-module4-couts" id="toc-sec-module4-couts" class="nav-link" data-scroll-target="#sec-module4-couts"><span class="header-section-number">6.9</span> Surveillance des Coûts</a></li>
  <li><a href="#sec-module4-exercice" id="toc-sec-module4-exercice" class="nav-link" data-scroll-target="#sec-module4-exercice"><span class="header-section-number">6.10</span> Exercice Pratique</a></li>
  <li><a href="#sec-module4-checkpoint" id="toc-sec-module4-checkpoint" class="nav-link" data-scroll-target="#sec-module4-checkpoint"><span class="header-section-number">6.11</span> Checkpoint</a></li>
  </ul></li>
  <li><a href="#sec-module5" id="toc-sec-module5" class="nav-link" data-scroll-target="#sec-module5"><span class="header-section-number">7</span> Module 5 : CI/CD avec GitHub Actions</a>
  <ul class="collapse">
  <li><a href="#sec-module5-objectif" id="toc-sec-module5-objectif" class="nav-link" data-scroll-target="#sec-module5-objectif"><span class="header-section-number">7.1</span> Objectif</a></li>
  <li><a href="#sec-module5-etape1" id="toc-sec-module5-etape1" class="nav-link" data-scroll-target="#sec-module5-etape1"><span class="header-section-number">7.2</span> Étape 1 : Initialisation du Repository Git</a></li>
  <li><a href="#sec-module5-etape2" id="toc-sec-module5-etape2" class="nav-link" data-scroll-target="#sec-module5-etape2"><span class="header-section-number">7.3</span> Étape 2 : Créer un Repository GitHub</a></li>
  <li><a href="#sec-module5-etape3" id="toc-sec-module5-etape3" class="nav-link" data-scroll-target="#sec-module5-etape3"><span class="header-section-number">7.4</span> Étape 3 : Configuration des Secrets GitHub</a></li>
  <li><a href="#sec-module5-etape4" id="toc-sec-module5-etape4" class="nav-link" data-scroll-target="#sec-module5-etape4"><span class="header-section-number">7.5</span> Étape 4 : Création du Workflow GitHub Actions</a></li>
  <li><a href="#sec-module5-etape5" id="toc-sec-module5-etape5" class="nav-link" data-scroll-target="#sec-module5-etape5"><span class="header-section-number">7.6</span> Étape 5 : Déclencher le Pipeline</a></li>
  <li><a href="#sec-module5-exercice" id="toc-sec-module5-exercice" class="nav-link" data-scroll-target="#sec-module5-exercice"><span class="header-section-number">7.7</span> Exercice Pratique</a></li>
  <li><a href="#sec-module5-checkpoint" id="toc-sec-module5-checkpoint" class="nav-link" data-scroll-target="#sec-module5-checkpoint"><span class="header-section-number">7.8</span> Checkpoint</a></li>
  </ul></li>
  <li><a href="#sec-module6" id="toc-sec-module6" class="nav-link" data-scroll-target="#sec-module6"><span class="header-section-number">8</span> Module 6 : Monitoring et Maintenance</a>
  <ul class="collapse">
  <li><a href="#sec-module6-objectif" id="toc-sec-module6-objectif" class="nav-link" data-scroll-target="#sec-module6-objectif"><span class="header-section-number">8.1</span> Objectif</a></li>
  <li><a href="#sec-module6-appinsights" id="toc-sec-module6-appinsights" class="nav-link" data-scroll-target="#sec-module6-appinsights"><span class="header-section-number">8.2</span> Configuration Application Insights</a></li>
  <li><a href="#sec-module6-monitoring" id="toc-sec-module6-monitoring" class="nav-link" data-scroll-target="#sec-module6-monitoring"><span class="header-section-number">8.3</span> Intégration du Monitoring dans le Code</a></li>
  <li><a href="#sec-module6-drift" id="toc-sec-module6-drift" class="nav-link" data-scroll-target="#sec-module6-drift"><span class="header-section-number">8.4</span> Détection de Data Drift</a></li>
  <li><a href="#sec-module6-checkpoint" id="toc-sec-module6-checkpoint" class="nav-link" data-scroll-target="#sec-module6-checkpoint"><span class="header-section-number">8.5</span> Checkpoint</a></li>
  </ul></li>
  <li><a href="#sec-module7" id="toc-sec-module7" class="nav-link" data-scroll-target="#sec-module7"><span class="header-section-number">9</span> Module 7 : Optimisations et Bonnes Pratiques</a>
  <ul class="collapse">
  <li><a href="#sec-module7-objectif" id="toc-sec-module7-objectif" class="nav-link" data-scroll-target="#sec-module7-objectif"><span class="header-section-number">9.1</span> Objectif</a></li>
  <li><a href="#sec-module7-cache" id="toc-sec-module7-cache" class="nav-link" data-scroll-target="#sec-module7-cache"><span class="header-section-number">9.2</span> Ajout d’un Cache pour les Prédictions</a></li>
  <li><a href="#sec-module7-checklist" id="toc-sec-module7-checklist" class="nav-link" data-scroll-target="#sec-module7-checklist"><span class="header-section-number">9.3</span> Checklist de Production</a></li>
  <li><a href="#sec-module7-checkpoint" id="toc-sec-module7-checkpoint" class="nav-link" data-scroll-target="#sec-module7-checkpoint"><span class="header-section-number">9.4</span> Checkpoint Final</a></li>
  </ul></li>
  <li><a href="#sec-nettoyage" id="toc-sec-nettoyage" class="nav-link" data-scroll-target="#sec-nettoyage"><span class="header-section-number">10</span> Nettoyage des Ressources Azure</a>
  <ul class="collapse">
  <li><a href="#sec-nettoyage-important" id="toc-sec-nettoyage-important" class="nav-link" data-scroll-target="#sec-nettoyage-important"><span class="header-section-number">10.1</span> IMPORTANT - Suppression pour Éviter les Coûts</a></li>
  <li><a href="#sec-nettoyage-script" id="toc-sec-nettoyage-script" class="nav-link" data-scroll-target="#sec-nettoyage-script"><span class="header-section-number">10.2</span> Script de Nettoyage Automatique</a></li>
  </ul></li>
  <li><a href="#sec-recapitulatif" id="toc-sec-recapitulatif" class="nav-link" data-scroll-target="#sec-recapitulatif"><span class="header-section-number">11</span> Récapitulatif du Workshop</a>
  <ul class="collapse">
  <li><a href="#sec-recap-accompli" id="toc-sec-recap-accompli" class="nav-link" data-scroll-target="#sec-recap-accompli"><span class="header-section-number">11.1</span> Ce que Vous Avez Accompli</a></li>
  <li><a href="#sec-recap-competences" id="toc-sec-recap-competences" class="nav-link" data-scroll-target="#sec-recap-competences"><span class="header-section-number">11.2</span> Compétences Acquises</a></li>
  <li><a href="#sec-recap-points-cles" id="toc-sec-recap-points-cles" class="nav-link" data-scroll-target="#sec-recap-points-cles"><span class="header-section-number">11.3</span> Points Clés à Retenir</a></li>
  </ul></li>
  <li><a href="#sec-faq" id="toc-sec-faq" class="nav-link" data-scroll-target="#sec-faq"><span class="header-section-number">12</span> FAQ - Foire Aux Questions</a>
  <ul class="collapse">
  <li><a href="#sec-faq-techniques" id="toc-sec-faq-techniques" class="nav-link" data-scroll-target="#sec-faq-techniques"><span class="header-section-number">12.1</span> Questions Techniques</a></li>
  <li><a href="#sec-faq-comprehension" id="toc-sec-faq-comprehension" class="nav-link" data-scroll-target="#sec-faq-comprehension"><span class="header-section-number">12.2</span> Questions de Compréhension</a></li>
  </ul></li>
  <li><a href="#sec-conclusion" id="toc-sec-conclusion" class="nav-link" data-scroll-target="#sec-conclusion"><span class="header-section-number">13</span> Conclusion</a>
  <ul class="collapse">
  <li><a href="#sec-conclusion-felicitations" id="toc-sec-conclusion-felicitations" class="nav-link" data-scroll-target="#sec-conclusion-felicitations"><span class="header-section-number">13.1</span> Félicitations !</a></li>
  <li><a href="#sec-conclusion-next-steps" id="toc-sec-conclusion-next-steps" class="nav-link" data-scroll-target="#sec-conclusion-next-steps"><span class="header-section-number">13.2</span> Prochaines Étapes</a></li>
  </ul></li>
  </ul>
</nav>
</div>
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Workshop MLOps avec Azure - Guide Pratique Étudiant</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="sec-introduction" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="sec-introduction"><span class="header-section-number">1</span> Introduction</h2>
<section id="bienvenue" class="level3" data-number="1.1">
<h3 data-number="1.1" class="anchored" data-anchor-id="bienvenue"><span class="header-section-number">1.1</span> Bienvenue !</h3>
<p>Ce workshop vous guidera à travers le déploiement complet d’un modèle de Machine Learning en production sur Microsoft Azure. Vous allez construire une API de prédiction de défaillance client (churn) et la déployer sur le cloud avec toutes les bonnes pratiques MLOps.</p>
</section>
<section id="sec-objectifs" class="level3" data-number="1.2">
<h3 data-number="1.2" class="anchored" data-anchor-id="sec-objectifs"><span class="header-section-number">1.2</span> Objectifs d’Apprentissage</h3>
<p>À la fin de ce workshop, vous serez capable de :</p>
<ul>
<li>Entraîner et sauvegarder un modèle ML avec MLflow</li>
<li>Créer une API REST avec FastAPI</li>
<li>Conteneuriser une application avec Docker</li>
<li>Déployer sur Azure Container Apps</li>
<li>Mettre en place un pipeline CI/CD avec GitHub Actions</li>
<li>Monitorer votre application en production</li>
<li>Détecter le data drift</li>
</ul>
</section>
<section id="sec-projet" class="level3" data-number="1.3">
<h3 data-number="1.3" class="anchored" data-anchor-id="sec-projet"><span class="header-section-number">1.3</span> Le Projet : Bank Churn Prediction</h3>
<p><strong>Contexte :</strong> Une banque souhaite prédire quels clients risquent de partir pour proposer des actions de rétention.</p>
<p><strong>Dataset :</strong> 10 features (âge, score crédit, solde, etc.) + 1 target (Exited : 0/1)</p>
<p><strong>Modèle :</strong> Random Forest Classifier</p>
<p><strong>Livrable :</strong> API REST déployée sur Azure, accessible publiquement</p>
</section>
<section id="sec-architecture" class="level3" data-number="1.4">
<h3 data-number="1.4" class="anchored" data-anchor-id="sec-architecture"><span class="header-section-number">1.4</span> Architecture Finale</h3>
<p><strong>Flux de déploiement :</strong></p>
<p><code>Code GitHub</code> → <code>GitHub Actions</code> → <code>Docker Build</code> → <code>Azure Container Registry</code> → <code>Azure Container Apps</code> → <code>Internet</code></p>
</section>
</section>
<section id="sec-preparation" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="sec-preparation"><span class="header-section-number">2</span> Préparation de l’Environnement</h2>
<section id="sec-logiciels" class="level3" data-number="2.1">
<h3 data-number="2.1" class="anchored" data-anchor-id="sec-logiciels"><span class="header-section-number">2.1</span> Logiciels Requis</h3>
<p><strong>Obligatoire :</strong></p>
<ul>
<li>Python 3.9+ : https://www.python.org/downloads/</li>
<li>Visual Studio Code : https://code.visualstudio.com/</li>
<li>Git : https://git-scm.com/downloads</li>
<li>Docker Desktop : https://www.docker.com/products/docker-desktop</li>
<li>Azure CLI : https://docs.microsoft.com/cli/azure/install-azure-cli</li>
</ul>
<p><strong>Comptes à créer :</strong></p>
<ul>
<li>Compte GitHub : https://github.com/signup</li>
<li>Azure for Students (100$) : https://azure.microsoft.com/students</li>
</ul>
</section>
<section id="sec-verification" class="level3" data-number="2.2">
<h3 data-number="2.2" class="anchored" data-anchor-id="sec-verification"><span class="header-section-number">2.2</span> Vérification de l’Installation</h3>
<p>Ouvrez un terminal et testez :</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb1"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Python</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="ex">python</span> <span class="at">--version</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Doit afficher Python 3.9.x ou superieur</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Git</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> <span class="at">--version</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Docker</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> <span class="at">--version</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> ps</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Azure CLI</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="ex">az</span> <span class="at">--version</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="sec-configuration" class="level3" data-number="2.3">
<h3 data-number="2.3" class="anchored" data-anchor-id="sec-configuration"><span class="header-section-number">2.3</span> Configuration Initiale</h3>
<section id="sec-config-git" class="level4" data-number="2.3.1">
<h4 data-number="2.3.1" class="anchored" data-anchor-id="sec-config-git"><span class="header-section-number">2.3.1</span> Configuration Git</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb2"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> config <span class="at">--global</span> user.name <span class="st">"Votre Nom"</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> config <span class="at">--global</span> user.email <span class="st">"votre.email@example.com"</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="sec-config-azure" class="level4" data-number="2.3.2">
<h4 data-number="2.3.2" class="anchored" data-anchor-id="sec-config-azure"><span class="header-section-number">2.3.2</span> Connexion à Azure</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb3"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Se connecter a Azure</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="ex">az</span> login</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Verifier l'abonnement</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="ex">az</span> account show</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Si vous avez plusieurs abonnements, selectionner celui de Students</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="ex">az</span> account set <span class="at">--subscription</span> <span class="st">"Azure for Students"</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
</section>
</section>
<section id="sec-module1" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="sec-module1"><span class="header-section-number">3</span> Module 1 : Entraînement du Modèle</h2>
<section id="sec-module1-objectif" class="level3" data-number="3.1">
<h3 data-number="3.1" class="anchored" data-anchor-id="sec-module1-objectif"><span class="header-section-number">3.1</span> Objectif</h3>
<p>Entraîner un modèle Random Forest pour prédire le churn et le sauvegarder avec MLflow.</p>
</section>
<section id="sec-module1-preparation" class="level3" data-number="3.2">
<h3 data-number="3.2" class="anchored" data-anchor-id="sec-module1-preparation"><span class="header-section-number">3.2</span> Préparation du Projet</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb4"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Creer le dossier du projet</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> bank-churn-mlops</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> bank-churn-mlops</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Creer un environnement virtuel</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="ex">python</span> <span class="at">-m</span> venv venv</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Activer l'environnement</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Windows :</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="ex">venv\Scripts\activate</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Mac/Linux :</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a><span class="bu">source</span> venv/bin/activate</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Creer la structure</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> <span class="at">-p</span> data model app tests</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a><span class="fu">touch</span> requirements.txt</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="sec-module1-requirements" class="level3" data-number="3.3">
<h3 data-number="3.3" class="anchored" data-anchor-id="sec-module1-requirements"><span class="header-section-number">3.3</span> Fichier requirements.txt</h3>
<p>Créez le fichier <code>requirements.txt</code> avec le contenu suivant :</p>
<pre><code># API Framework
fastapi==0.104.1
uvicorn[standard]==0.24.0
pydantic==2.5.0

# Machine Learning
scikit-learn==1.3.2
pandas==2.1.3
numpy==1.26.2
joblib==1.3.2

# MLflow
mlflow==2.8.1

# Testing
pytest==7.4.3
pytest-cov==4.1.0
httpx==0.25.2

# Utilities
python-multipart==0.0.6
requests==2.31.0</code></pre>
<p>Puis installez les dépendances :</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb6"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="ex">pip</span> install <span class="at">-r</span> requirements.txt</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="sec-module1-dataset" class="level3" data-number="3.4">
<h3 data-number="3.4" class="anchored" data-anchor-id="sec-module1-dataset"><span class="header-section-number">3.4</span> Téléchargement du Dataset</h3>
<p>Créez un dataset synthétique :</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># generate_data.py</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>np.random.seed(<span class="dv">42</span>)</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>n_samples <span class="op">=</span> <span class="dv">10000</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> {</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">'CreditScore'</span>: np.random.randint(<span class="dv">300</span>, <span class="dv">850</span>, n_samples),</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Age'</span>: np.random.randint(<span class="dv">18</span>, <span class="dv">80</span>, n_samples),</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Tenure'</span>: np.random.randint(<span class="dv">0</span>, <span class="dv">11</span>, n_samples),</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Balance'</span>: np.random.uniform(<span class="dv">0</span>, <span class="dv">200000</span>, n_samples),</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">'NumOfProducts'</span>: np.random.randint(<span class="dv">1</span>, <span class="dv">5</span>, n_samples),</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">'HasCrCard'</span>: np.random.choice([<span class="dv">0</span>, <span class="dv">1</span>], n_samples),</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">'IsActiveMember'</span>: np.random.choice([<span class="dv">0</span>, <span class="dv">1</span>], n_samples),</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">'EstimatedSalary'</span>: np.random.uniform(<span class="dv">20000</span>, <span class="dv">150000</span>, n_samples),</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Geography_Germany'</span>: np.random.choice([<span class="dv">0</span>, <span class="dv">1</span>], n_samples),</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">'Geography_Spain'</span>: np.random.choice([<span class="dv">0</span>, <span class="dv">1</span>], n_samples),</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Target : plus de chance de partir si inactif, peu de produits, etc.</span></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>churn_prob <span class="op">=</span> (</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>    (<span class="dv">1</span> <span class="op">-</span> data[<span class="st">'IsActiveMember'</span>]) <span class="op">*</span> <span class="fl">0.3</span> <span class="op">+</span></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>    (data[<span class="st">'NumOfProducts'</span>] <span class="op">==</span> <span class="dv">1</span>) <span class="op">*</span> <span class="fl">0.2</span> <span class="op">+</span></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>    (data[<span class="st">'Age'</span>] <span class="op">&gt;</span> <span class="dv">60</span>) <span class="op">*</span> <span class="fl">0.15</span> <span class="op">+</span></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>    (data[<span class="st">'Balance'</span>] <span class="op">==</span> <span class="dv">0</span>) <span class="op">*</span> <span class="fl">0.25</span></span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>data[<span class="st">'Exited'</span>] <span class="op">=</span> (np.random.random(n_samples) <span class="op">&lt;</span> churn_prob).astype(<span class="bu">int</span>)</span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.DataFrame(data)</span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>df.to_csv(<span class="st">'data/bank_churn.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Dataset cree : </span><span class="sc">{</span><span class="bu">len</span>(df)<span class="sc">}</span><span class="ss"> lignes"</span>)</span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Taux de churn : </span><span class="sc">{</span>df[<span class="st">'Exited'</span>]<span class="sc">.</span>mean()<span class="sc">:.2%}</span><span class="ss">"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="sec-module1-training" class="level3" data-number="3.5">
<h3 data-number="3.5" class="anchored" data-anchor-id="sec-module1-training"><span class="header-section-number">3.5</span> Script d’Entraînement</h3>
<p>Créez le fichier <code>train_model.py</code> :</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> train_test_split</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.ensemble <span class="im">import</span> RandomForestClassifier</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> (</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    accuracy_score, </span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    precision_score, </span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    recall_score,</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    f1_score, </span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    roc_auc_score,</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>    confusion_matrix</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> joblib</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> mlflow</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> mlflow.sklearn</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Configuration MLflow</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>mlflow.set_tracking_uri(<span class="st">"./mlruns"</span>)</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>mlflow.set_experiment(<span class="st">"bank-churn-prediction"</span>)</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Chargement des donnees..."</span>)</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(<span class="st">"data/bank_churn.csv"</span>)</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Dataset : </span><span class="sc">{</span><span class="bu">len</span>(df)<span class="sc">}</span><span class="ss"> lignes, </span><span class="sc">{</span><span class="bu">len</span>(df.columns)<span class="sc">}</span><span class="ss"> colonnes"</span>)</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Taux de churn : </span><span class="sc">{</span>df[<span class="st">'Exited'</span>]<span class="sc">.</span>mean()<span class="sc">:.2%}</span><span class="ss">"</span>)</span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Separation features/target</span></span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> df.drop(<span class="st">'Exited'</span>, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> df[<span class="st">'Exited'</span>]</span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Split train/test (80/20)</span></span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>X_train, X_test, y_train, y_test <span class="op">=</span> train_test_split(</span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>    X, y, test_size<span class="op">=</span><span class="fl">0.2</span>, random_state<span class="op">=</span><span class="dv">42</span>, stratify<span class="op">=</span>y</span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Train : </span><span class="sc">{</span><span class="bu">len</span>(X_train)<span class="sc">}</span><span class="ss"> lignes"</span>)</span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Test : </span><span class="sc">{</span><span class="bu">len</span>(X_test)<span class="sc">}</span><span class="ss"> lignes"</span>)</span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a><span class="co"># Entrainement avec MLflow tracking</span></span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Entrainement du modele..."</span>)</span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> mlflow.start_run(run_name<span class="op">=</span><span class="st">"random-forest-v1"</span>):</span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Parametres du modele</span></span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a>    params <span class="op">=</span> {</span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a>        <span class="st">'n_estimators'</span>: <span class="dv">100</span>,</span>
<span id="cb8-48"><a href="#cb8-48" aria-hidden="true" tabindex="-1"></a>        <span class="st">'max_depth'</span>: <span class="dv">10</span>,</span>
<span id="cb8-49"><a href="#cb8-49" aria-hidden="true" tabindex="-1"></a>        <span class="st">'min_samples_split'</span>: <span class="dv">5</span>,</span>
<span id="cb8-50"><a href="#cb8-50" aria-hidden="true" tabindex="-1"></a>        <span class="st">'random_state'</span>: <span class="dv">42</span></span>
<span id="cb8-51"><a href="#cb8-51" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb8-52"><a href="#cb8-52" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-53"><a href="#cb8-53" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Entrainement</span></span>
<span id="cb8-54"><a href="#cb8-54" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> RandomForestClassifier(<span class="op">**</span>params)</span>
<span id="cb8-55"><a href="#cb8-55" aria-hidden="true" tabindex="-1"></a>    model.fit(X_train, y_train)</span>
<span id="cb8-56"><a href="#cb8-56" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-57"><a href="#cb8-57" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Predictions</span></span>
<span id="cb8-58"><a href="#cb8-58" aria-hidden="true" tabindex="-1"></a>    y_pred <span class="op">=</span> model.predict(X_test)</span>
<span id="cb8-59"><a href="#cb8-59" aria-hidden="true" tabindex="-1"></a>    y_proba <span class="op">=</span> model.predict_proba(X_test)[:, <span class="dv">1</span>]</span>
<span id="cb8-60"><a href="#cb8-60" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-61"><a href="#cb8-61" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calcul des metriques</span></span>
<span id="cb8-62"><a href="#cb8-62" aria-hidden="true" tabindex="-1"></a>    accuracy <span class="op">=</span> accuracy_score(y_test, y_pred)</span>
<span id="cb8-63"><a href="#cb8-63" aria-hidden="true" tabindex="-1"></a>    precision <span class="op">=</span> precision_score(y_test, y_pred)</span>
<span id="cb8-64"><a href="#cb8-64" aria-hidden="true" tabindex="-1"></a>    recall <span class="op">=</span> recall_score(y_test, y_pred)</span>
<span id="cb8-65"><a href="#cb8-65" aria-hidden="true" tabindex="-1"></a>    f1 <span class="op">=</span> f1_score(y_test, y_pred)</span>
<span id="cb8-66"><a href="#cb8-66" aria-hidden="true" tabindex="-1"></a>    auc <span class="op">=</span> roc_auc_score(y_test, y_proba)</span>
<span id="cb8-67"><a href="#cb8-67" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-68"><a href="#cb8-68" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Log des parametres et metriques dans MLflow</span></span>
<span id="cb8-69"><a href="#cb8-69" aria-hidden="true" tabindex="-1"></a>    mlflow.log_params(params)</span>
<span id="cb8-70"><a href="#cb8-70" aria-hidden="true" tabindex="-1"></a>    mlflow.log_metrics({</span>
<span id="cb8-71"><a href="#cb8-71" aria-hidden="true" tabindex="-1"></a>        <span class="st">"accuracy"</span>: accuracy,</span>
<span id="cb8-72"><a href="#cb8-72" aria-hidden="true" tabindex="-1"></a>        <span class="st">"precision"</span>: precision,</span>
<span id="cb8-73"><a href="#cb8-73" aria-hidden="true" tabindex="-1"></a>        <span class="st">"recall"</span>: recall,</span>
<span id="cb8-74"><a href="#cb8-74" aria-hidden="true" tabindex="-1"></a>        <span class="st">"f1_score"</span>: f1,</span>
<span id="cb8-75"><a href="#cb8-75" aria-hidden="true" tabindex="-1"></a>        <span class="st">"roc_auc"</span>: auc</span>
<span id="cb8-76"><a href="#cb8-76" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb8-77"><a href="#cb8-77" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-78"><a href="#cb8-78" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Creation et sauvegarde de la matrice de confusion</span></span>
<span id="cb8-79"><a href="#cb8-79" aria-hidden="true" tabindex="-1"></a>    cm <span class="op">=</span> confusion_matrix(y_test, y_pred)</span>
<span id="cb8-80"><a href="#cb8-80" aria-hidden="true" tabindex="-1"></a>    plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">6</span>))</span>
<span id="cb8-81"><a href="#cb8-81" aria-hidden="true" tabindex="-1"></a>    sns.heatmap(cm, annot<span class="op">=</span><span class="va">True</span>, fmt<span class="op">=</span><span class="st">'d'</span>, cmap<span class="op">=</span><span class="st">'Blues'</span>)</span>
<span id="cb8-82"><a href="#cb8-82" aria-hidden="true" tabindex="-1"></a>    plt.title(<span class="st">'Matrice de Confusion'</span>)</span>
<span id="cb8-83"><a href="#cb8-83" aria-hidden="true" tabindex="-1"></a>    plt.ylabel(<span class="st">'Vraie Classe'</span>)</span>
<span id="cb8-84"><a href="#cb8-84" aria-hidden="true" tabindex="-1"></a>    plt.xlabel(<span class="st">'Classe Predite'</span>)</span>
<span id="cb8-85"><a href="#cb8-85" aria-hidden="true" tabindex="-1"></a>    plt.savefig(<span class="st">'confusion_matrix.png'</span>)</span>
<span id="cb8-86"><a href="#cb8-86" aria-hidden="true" tabindex="-1"></a>    mlflow.log_artifact(<span class="st">'confusion_matrix.png'</span>)</span>
<span id="cb8-87"><a href="#cb8-87" aria-hidden="true" tabindex="-1"></a>    plt.close()</span>
<span id="cb8-88"><a href="#cb8-88" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-89"><a href="#cb8-89" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Feature importance</span></span>
<span id="cb8-90"><a href="#cb8-90" aria-hidden="true" tabindex="-1"></a>    feature_importance <span class="op">=</span> pd.DataFrame({</span>
<span id="cb8-91"><a href="#cb8-91" aria-hidden="true" tabindex="-1"></a>        <span class="st">'feature'</span>: X.columns,</span>
<span id="cb8-92"><a href="#cb8-92" aria-hidden="true" tabindex="-1"></a>        <span class="st">'importance'</span>: model.feature_importances_</span>
<span id="cb8-93"><a href="#cb8-93" aria-hidden="true" tabindex="-1"></a>    }).sort_values(<span class="st">'importance'</span>, ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb8-94"><a href="#cb8-94" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-95"><a href="#cb8-95" aria-hidden="true" tabindex="-1"></a>    plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb8-96"><a href="#cb8-96" aria-hidden="true" tabindex="-1"></a>    plt.barh(feature_importance[<span class="st">'feature'</span>], feature_importance[<span class="st">'importance'</span>])</span>
<span id="cb8-97"><a href="#cb8-97" aria-hidden="true" tabindex="-1"></a>    plt.xlabel(<span class="st">'Importance'</span>)</span>
<span id="cb8-98"><a href="#cb8-98" aria-hidden="true" tabindex="-1"></a>    plt.title(<span class="st">'Feature Importance'</span>)</span>
<span id="cb8-99"><a href="#cb8-99" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb8-100"><a href="#cb8-100" aria-hidden="true" tabindex="-1"></a>    plt.savefig(<span class="st">'feature_importance.png'</span>)</span>
<span id="cb8-101"><a href="#cb8-101" aria-hidden="true" tabindex="-1"></a>    mlflow.log_artifact(<span class="st">'feature_importance.png'</span>)</span>
<span id="cb8-102"><a href="#cb8-102" aria-hidden="true" tabindex="-1"></a>    plt.close()</span>
<span id="cb8-103"><a href="#cb8-103" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-104"><a href="#cb8-104" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Enregistrement du modele dans MLflow</span></span>
<span id="cb8-105"><a href="#cb8-105" aria-hidden="true" tabindex="-1"></a>    mlflow.sklearn.log_model(</span>
<span id="cb8-106"><a href="#cb8-106" aria-hidden="true" tabindex="-1"></a>        model,</span>
<span id="cb8-107"><a href="#cb8-107" aria-hidden="true" tabindex="-1"></a>        <span class="st">"model"</span>,</span>
<span id="cb8-108"><a href="#cb8-108" aria-hidden="true" tabindex="-1"></a>        registered_model_name<span class="op">=</span><span class="st">"bank-churn-classifier"</span></span>
<span id="cb8-109"><a href="#cb8-109" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb8-110"><a href="#cb8-110" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-111"><a href="#cb8-111" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sauvegarde locale du modele</span></span>
<span id="cb8-112"><a href="#cb8-112" aria-hidden="true" tabindex="-1"></a>    joblib.dump(model, <span class="st">"model/churn_model.pkl"</span>)</span>
<span id="cb8-113"><a href="#cb8-113" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-114"><a href="#cb8-114" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Tags</span></span>
<span id="cb8-115"><a href="#cb8-115" aria-hidden="true" tabindex="-1"></a>    mlflow.set_tags({</span>
<span id="cb8-116"><a href="#cb8-116" aria-hidden="true" tabindex="-1"></a>        <span class="st">"environment"</span>: <span class="st">"development"</span>,</span>
<span id="cb8-117"><a href="#cb8-117" aria-hidden="true" tabindex="-1"></a>        <span class="st">"model_type"</span>: <span class="st">"RandomForest"</span>,</span>
<span id="cb8-118"><a href="#cb8-118" aria-hidden="true" tabindex="-1"></a>        <span class="st">"task"</span>: <span class="st">"binary_classification"</span></span>
<span id="cb8-119"><a href="#cb8-119" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb8-120"><a href="#cb8-120" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-121"><a href="#cb8-121" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Affichage des resultats</span></span>
<span id="cb8-122"><a href="#cb8-122" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">"</span> <span class="op">+</span> <span class="st">"="</span><span class="op">*</span><span class="dv">50</span>)</span>
<span id="cb8-123"><a href="#cb8-123" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"RESULTATS DE L'ENTRAINEMENT"</span>)</span>
<span id="cb8-124"><a href="#cb8-124" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">50</span>)</span>
<span id="cb8-125"><a href="#cb8-125" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Accuracy  : </span><span class="sc">{</span>accuracy<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb8-126"><a href="#cb8-126" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Precision : </span><span class="sc">{</span>precision<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb8-127"><a href="#cb8-127" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Recall    : </span><span class="sc">{</span>recall<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb8-128"><a href="#cb8-128" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"F1 Score  : </span><span class="sc">{</span>f1<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb8-129"><a href="#cb8-129" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"ROC AUC   : </span><span class="sc">{</span>auc<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb8-130"><a href="#cb8-130" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">50</span>)</span>
<span id="cb8-131"><a href="#cb8-131" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-132"><a href="#cb8-132" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Modele sauvegarde dans : model/churn_model.pkl"</span>)</span>
<span id="cb8-133"><a href="#cb8-133" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"MLflow UI : mlflow ui --port 5000"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="sec-module1-execution" class="level3" data-number="3.6">
<h3 data-number="3.6" class="anchored" data-anchor-id="sec-module1-execution"><span class="header-section-number">3.6</span> Exécution</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb9"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Lancer l'entrainement</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="ex">python</span> train_model.py</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Voir les resultats dans MLflow UI</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="ex">mlflow</span> ui <span class="at">--port</span> 5000</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Ouvrir http://localhost:5000 dans votre navigateur</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="sec-module1-checkpoint" class="level3" data-number="3.7">
<h3 data-number="3.7" class="anchored" data-anchor-id="sec-module1-checkpoint"><span class="header-section-number">3.7</span> Checkpoint</h3>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Validation Module 1
</div>
</div>
<div class="callout-body-container callout-body">
Avant de passer au module suivant, vérifiez que :
<div style="margin-left: 20px;">
<ul class="task-list">
<li><label><input type="checkbox">Le modèle est entraîné avec une accuracy &gt; 0.75</label></li>
<li><label><input type="checkbox">Le fichier <code>model/churn_model.pkl</code> existe</label></li>
<li><label><input type="checkbox">MLflow UI affiche votre expérience</label></li>
<li><label><input type="checkbox">Vous comprenez les métriques obtenues</label></li>
</ul>
</div>
</div>
</div>
</section>
</section>
<section id="sec-module2" class="level2" data-number="4">
<h2 data-number="4" class="anchored" data-anchor-id="sec-module2"><span class="header-section-number">4</span> Module 2 : Création de l’API avec FastAPI</h2>
<section id="sec-module2-objectif" class="level3" data-number="4.1">
<h3 data-number="4.1" class="anchored" data-anchor-id="sec-module2-objectif"><span class="header-section-number">4.1</span> Objectif</h3>
<p>Créer une API REST qui expose le modèle via des endpoints HTTP.</p>
</section>
<section id="sec-module2-structure" class="level3" data-number="4.2">
<h3 data-number="4.2" class="anchored" data-anchor-id="sec-module2-structure"><span class="header-section-number">4.2</span> Structure du Code API</h3>
<pre><code>bank-churn-mlops/
|-- app/
|   |-- __init__.py
|   |-- main.py
|   |-- models.py
|   +-- utils.py
|-- model/
|   +-- churn_model.pkl
|-- tests/
|   +-- test_api.py
|-- requirements.txt
+-- README.md</code></pre>
</section>
<section id="sec-module2-models" class="level3" data-number="4.3">
<h3 data-number="4.3" class="anchored" data-anchor-id="sec-module2-models"><span class="header-section-number">4.3</span> Fichier app/models.py</h3>
<p>Définition des schémas de données avec Pydantic :</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pydantic <span class="im">import</span> BaseModel, Field</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> List</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> CustomerFeatures(BaseModel):</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Schema pour les features d'un client"""</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    CreditScore: <span class="bu">int</span> <span class="op">=</span> Field(..., ge<span class="op">=</span><span class="dv">300</span>, le<span class="op">=</span><span class="dv">850</span>, description<span class="op">=</span><span class="st">"Score de credit"</span>)</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>    Age: <span class="bu">int</span> <span class="op">=</span> Field(..., ge<span class="op">=</span><span class="dv">18</span>, le<span class="op">=</span><span class="dv">100</span>, description<span class="op">=</span><span class="st">"Age du client"</span>)</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>    Tenure: <span class="bu">int</span> <span class="op">=</span> Field(..., ge<span class="op">=</span><span class="dv">0</span>, le<span class="op">=</span><span class="dv">10</span>, description<span class="op">=</span><span class="st">"Anciennete en annees"</span>)</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    Balance: <span class="bu">float</span> <span class="op">=</span> Field(..., ge<span class="op">=</span><span class="dv">0</span>, description<span class="op">=</span><span class="st">"Solde du compte"</span>)</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>    NumOfProducts: <span class="bu">int</span> <span class="op">=</span> Field(..., ge<span class="op">=</span><span class="dv">1</span>, le<span class="op">=</span><span class="dv">4</span>, description<span class="op">=</span><span class="st">"Nombre de produits"</span>)</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>    HasCrCard: <span class="bu">int</span> <span class="op">=</span> Field(..., ge<span class="op">=</span><span class="dv">0</span>, le<span class="op">=</span><span class="dv">1</span>, description<span class="op">=</span><span class="st">"Possession carte credit"</span>)</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>    IsActiveMember: <span class="bu">int</span> <span class="op">=</span> Field(..., ge<span class="op">=</span><span class="dv">0</span>, le<span class="op">=</span><span class="dv">1</span>, description<span class="op">=</span><span class="st">"Membre actif"</span>)</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>    EstimatedSalary: <span class="bu">float</span> <span class="op">=</span> Field(..., ge<span class="op">=</span><span class="dv">0</span>, description<span class="op">=</span><span class="st">"Salaire estime"</span>)</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>    Geography_Germany: <span class="bu">int</span> <span class="op">=</span> Field(..., ge<span class="op">=</span><span class="dv">0</span>, le<span class="op">=</span><span class="dv">1</span>, description<span class="op">=</span><span class="st">"Client allemand"</span>)</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>    Geography_Spain: <span class="bu">int</span> <span class="op">=</span> Field(..., ge<span class="op">=</span><span class="dv">0</span>, le<span class="op">=</span><span class="dv">1</span>, description<span class="op">=</span><span class="st">"Client espagnol"</span>)</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">class</span> Config:</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>        schema_extra <span class="op">=</span> {</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>            <span class="st">"example"</span>: {</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>                <span class="st">"CreditScore"</span>: <span class="dv">650</span>,</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>                <span class="st">"Age"</span>: <span class="dv">35</span>,</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>                <span class="st">"Tenure"</span>: <span class="dv">5</span>,</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>                <span class="st">"Balance"</span>: <span class="dv">50000</span>,</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>                <span class="st">"NumOfProducts"</span>: <span class="dv">2</span>,</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>                <span class="st">"HasCrCard"</span>: <span class="dv">1</span>,</span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>                <span class="st">"IsActiveMember"</span>: <span class="dv">1</span>,</span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>                <span class="st">"EstimatedSalary"</span>: <span class="dv">75000</span>,</span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>                <span class="st">"Geography_Germany"</span>: <span class="dv">0</span>,</span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>                <span class="st">"Geography_Spain"</span>: <span class="dv">1</span></span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> PredictionResponse(BaseModel):</span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Schema pour la reponse de prediction"""</span></span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>    churn_probability: <span class="bu">float</span> <span class="op">=</span> Field(..., description<span class="op">=</span><span class="st">"Probabilite de churn (0-1)"</span>)</span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a>    prediction: <span class="bu">int</span> <span class="op">=</span> Field(..., description<span class="op">=</span><span class="st">"Prediction binaire (0=reste, 1=part)"</span>)</span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>    risk_level: <span class="bu">str</span> <span class="op">=</span> Field(..., description<span class="op">=</span><span class="st">"Niveau de risque (Low/Medium/High)"</span>)</span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> HealthResponse(BaseModel):</span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Schema pour le health check"""</span></span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a>    status: <span class="bu">str</span></span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a>    model_loaded: <span class="bu">bool</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="sec-module2-main" class="level3" data-number="4.4">
<h3 data-number="4.4" class="anchored" data-anchor-id="sec-module2-main"><span class="header-section-number">4.4</span> Fichier app/main.py</h3>
<p>L’API principale :</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastapi <span class="im">import</span> FastAPI, HTTPException</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastapi.middleware.cors <span class="im">import</span> CORSMiddleware</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> joblib</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> List</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> logging</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> app.models <span class="im">import</span> CustomerFeatures, PredictionResponse, HealthResponse</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Configuration du logging</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>logging.basicConfig(level<span class="op">=</span>logging.INFO)</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>logger <span class="op">=</span> logging.getLogger(<span class="va">__name__</span>)</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialisation FastAPI</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>app <span class="op">=</span> FastAPI(</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>    title<span class="op">=</span><span class="st">"Bank Churn Prediction API"</span>,</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>    description<span class="op">=</span><span class="st">"API de prediction de defaillance client"</span>,</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>    version<span class="op">=</span><span class="st">"1.0.0"</span>,</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>    docs_url<span class="op">=</span><span class="st">"/docs"</span>,</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>    redoc_url<span class="op">=</span><span class="st">"/redoc"</span></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a><span class="co"># CORS pour permettre les requetes depuis un navigateur</span></span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>app.add_middleware(</span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>    CORSMiddleware,</span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>    allow_origins<span class="op">=</span>[<span class="st">"*"</span>],</span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>    allow_credentials<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>    allow_methods<span class="op">=</span>[<span class="st">"*"</span>],</span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>    allow_headers<span class="op">=</span>[<span class="st">"*"</span>],</span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Chargement du modele au demarrage</span></span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a>MODEL_PATH <span class="op">=</span> os.getenv(<span class="st">"MODEL_PATH"</span>, <span class="st">"model/churn_model.pkl"</span>)</span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> <span class="va">None</span></span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a><span class="at">@app.on_event</span>(<span class="st">"startup"</span>)</span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> load_model():</span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Charge le modele au demarrage de l'API"""</span></span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a>    <span class="kw">global</span> model</span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true" tabindex="-1"></a>        model <span class="op">=</span> joblib.load(MODEL_PATH)</span>
<span id="cb12-43"><a href="#cb12-43" aria-hidden="true" tabindex="-1"></a>        logger.info(<span class="ss">f"Modele charge avec succes depuis </span><span class="sc">{</span>MODEL_PATH<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb12-44"><a href="#cb12-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb12-45"><a href="#cb12-45" aria-hidden="true" tabindex="-1"></a>        logger.error(<span class="ss">f"Erreur lors du chargement du modele : </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb12-46"><a href="#cb12-46" aria-hidden="true" tabindex="-1"></a>        model <span class="op">=</span> <span class="va">None</span></span>
<span id="cb12-47"><a href="#cb12-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-48"><a href="#cb12-48" aria-hidden="true" tabindex="-1"></a><span class="at">@app.get</span>(<span class="st">"/"</span>, tags<span class="op">=</span>[<span class="st">"General"</span>])</span>
<span id="cb12-49"><a href="#cb12-49" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> root():</span>
<span id="cb12-50"><a href="#cb12-50" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Endpoint racine"""</span></span>
<span id="cb12-51"><a href="#cb12-51" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb12-52"><a href="#cb12-52" aria-hidden="true" tabindex="-1"></a>        <span class="st">"message"</span>: <span class="st">"Bank Churn Prediction API"</span>,</span>
<span id="cb12-53"><a href="#cb12-53" aria-hidden="true" tabindex="-1"></a>        <span class="st">"version"</span>: <span class="st">"1.0.0"</span>,</span>
<span id="cb12-54"><a href="#cb12-54" aria-hidden="true" tabindex="-1"></a>        <span class="st">"status"</span>: <span class="st">"running"</span>,</span>
<span id="cb12-55"><a href="#cb12-55" aria-hidden="true" tabindex="-1"></a>        <span class="st">"docs"</span>: <span class="st">"/docs"</span></span>
<span id="cb12-56"><a href="#cb12-56" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb12-57"><a href="#cb12-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-58"><a href="#cb12-58" aria-hidden="true" tabindex="-1"></a><span class="at">@app.get</span>(<span class="st">"/health"</span>, response_model<span class="op">=</span>HealthResponse, tags<span class="op">=</span>[<span class="st">"General"</span>])</span>
<span id="cb12-59"><a href="#cb12-59" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> health_check():</span>
<span id="cb12-60"><a href="#cb12-60" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Verification de l'etat de l'API"""</span></span>
<span id="cb12-61"><a href="#cb12-61" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> model <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb12-62"><a href="#cb12-62" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> HTTPException(</span>
<span id="cb12-63"><a href="#cb12-63" aria-hidden="true" tabindex="-1"></a>            status_code<span class="op">=</span><span class="dv">503</span>, </span>
<span id="cb12-64"><a href="#cb12-64" aria-hidden="true" tabindex="-1"></a>            detail<span class="op">=</span><span class="st">"Modele non charge"</span></span>
<span id="cb12-65"><a href="#cb12-65" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb12-66"><a href="#cb12-66" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb12-67"><a href="#cb12-67" aria-hidden="true" tabindex="-1"></a>        <span class="st">"status"</span>: <span class="st">"healthy"</span>,</span>
<span id="cb12-68"><a href="#cb12-68" aria-hidden="true" tabindex="-1"></a>        <span class="st">"model_loaded"</span>: <span class="va">True</span></span>
<span id="cb12-69"><a href="#cb12-69" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb12-70"><a href="#cb12-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-71"><a href="#cb12-71" aria-hidden="true" tabindex="-1"></a><span class="at">@app.post</span>(<span class="st">"/predict"</span>, response_model<span class="op">=</span>PredictionResponse, tags<span class="op">=</span>[<span class="st">"Prediction"</span>])</span>
<span id="cb12-72"><a href="#cb12-72" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> predict(features: CustomerFeatures):</span>
<span id="cb12-73"><a href="#cb12-73" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb12-74"><a href="#cb12-74" aria-hidden="true" tabindex="-1"></a><span class="co">    Predit si un client va partir (churn)</span></span>
<span id="cb12-75"><a href="#cb12-75" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb12-76"><a href="#cb12-76" aria-hidden="true" tabindex="-1"></a><span class="co">    Retourne :</span></span>
<span id="cb12-77"><a href="#cb12-77" aria-hidden="true" tabindex="-1"></a><span class="co">    - churn_probability : probabilite de churn (0 a 1)</span></span>
<span id="cb12-78"><a href="#cb12-78" aria-hidden="true" tabindex="-1"></a><span class="co">    - prediction : 0 (reste) ou 1 (part)</span></span>
<span id="cb12-79"><a href="#cb12-79" aria-hidden="true" tabindex="-1"></a><span class="co">    - risk_level : Low, Medium ou High</span></span>
<span id="cb12-80"><a href="#cb12-80" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb12-81"><a href="#cb12-81" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> model <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb12-82"><a href="#cb12-82" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> HTTPException(</span>
<span id="cb12-83"><a href="#cb12-83" aria-hidden="true" tabindex="-1"></a>            status_code<span class="op">=</span><span class="dv">503</span>, </span>
<span id="cb12-84"><a href="#cb12-84" aria-hidden="true" tabindex="-1"></a>            detail<span class="op">=</span><span class="st">"Modele non disponible"</span></span>
<span id="cb12-85"><a href="#cb12-85" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb12-86"><a href="#cb12-86" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-87"><a href="#cb12-87" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb12-88"><a href="#cb12-88" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Preparation des features</span></span>
<span id="cb12-89"><a href="#cb12-89" aria-hidden="true" tabindex="-1"></a>        input_data <span class="op">=</span> np.array([[</span>
<span id="cb12-90"><a href="#cb12-90" aria-hidden="true" tabindex="-1"></a>            features.CreditScore,</span>
<span id="cb12-91"><a href="#cb12-91" aria-hidden="true" tabindex="-1"></a>            features.Age,</span>
<span id="cb12-92"><a href="#cb12-92" aria-hidden="true" tabindex="-1"></a>            features.Tenure,</span>
<span id="cb12-93"><a href="#cb12-93" aria-hidden="true" tabindex="-1"></a>            features.Balance,</span>
<span id="cb12-94"><a href="#cb12-94" aria-hidden="true" tabindex="-1"></a>            features.NumOfProducts,</span>
<span id="cb12-95"><a href="#cb12-95" aria-hidden="true" tabindex="-1"></a>            features.HasCrCard,</span>
<span id="cb12-96"><a href="#cb12-96" aria-hidden="true" tabindex="-1"></a>            features.IsActiveMember,</span>
<span id="cb12-97"><a href="#cb12-97" aria-hidden="true" tabindex="-1"></a>            features.EstimatedSalary,</span>
<span id="cb12-98"><a href="#cb12-98" aria-hidden="true" tabindex="-1"></a>            features.Geography_Germany,</span>
<span id="cb12-99"><a href="#cb12-99" aria-hidden="true" tabindex="-1"></a>            features.Geography_Spain</span>
<span id="cb12-100"><a href="#cb12-100" aria-hidden="true" tabindex="-1"></a>        ]])</span>
<span id="cb12-101"><a href="#cb12-101" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-102"><a href="#cb12-102" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Prediction</span></span>
<span id="cb12-103"><a href="#cb12-103" aria-hidden="true" tabindex="-1"></a>        proba <span class="op">=</span> model.predict_proba(input_data)[<span class="dv">0</span>, <span class="dv">1</span>]</span>
<span id="cb12-104"><a href="#cb12-104" aria-hidden="true" tabindex="-1"></a>        prediction <span class="op">=</span> <span class="bu">int</span>(proba <span class="op">&gt;</span> <span class="fl">0.5</span>)</span>
<span id="cb12-105"><a href="#cb12-105" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-106"><a href="#cb12-106" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Classification du risque</span></span>
<span id="cb12-107"><a href="#cb12-107" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> proba <span class="op">&lt;</span> <span class="fl">0.3</span>:</span>
<span id="cb12-108"><a href="#cb12-108" aria-hidden="true" tabindex="-1"></a>            risk <span class="op">=</span> <span class="st">"Low"</span></span>
<span id="cb12-109"><a href="#cb12-109" aria-hidden="true" tabindex="-1"></a>        <span class="cf">elif</span> proba <span class="op">&lt;</span> <span class="fl">0.7</span>:</span>
<span id="cb12-110"><a href="#cb12-110" aria-hidden="true" tabindex="-1"></a>            risk <span class="op">=</span> <span class="st">"Medium"</span></span>
<span id="cb12-111"><a href="#cb12-111" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb12-112"><a href="#cb12-112" aria-hidden="true" tabindex="-1"></a>            risk <span class="op">=</span> <span class="st">"High"</span></span>
<span id="cb12-113"><a href="#cb12-113" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-114"><a href="#cb12-114" aria-hidden="true" tabindex="-1"></a>        logger.info(</span>
<span id="cb12-115"><a href="#cb12-115" aria-hidden="true" tabindex="-1"></a>            <span class="ss">f"Prediction effectuee : proba=</span><span class="sc">{</span>proba<span class="sc">:.4f}</span><span class="ss">, "</span></span>
<span id="cb12-116"><a href="#cb12-116" aria-hidden="true" tabindex="-1"></a>            <span class="ss">f"prediction=</span><span class="sc">{</span>prediction<span class="sc">}</span><span class="ss">, risk=</span><span class="sc">{</span>risk<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb12-117"><a href="#cb12-117" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb12-118"><a href="#cb12-118" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-119"><a href="#cb12-119" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {</span>
<span id="cb12-120"><a href="#cb12-120" aria-hidden="true" tabindex="-1"></a>            <span class="st">"churn_probability"</span>: <span class="bu">round</span>(<span class="bu">float</span>(proba), <span class="dv">4</span>),</span>
<span id="cb12-121"><a href="#cb12-121" aria-hidden="true" tabindex="-1"></a>            <span class="st">"prediction"</span>: prediction,</span>
<span id="cb12-122"><a href="#cb12-122" aria-hidden="true" tabindex="-1"></a>            <span class="st">"risk_level"</span>: risk</span>
<span id="cb12-123"><a href="#cb12-123" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb12-124"><a href="#cb12-124" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-125"><a href="#cb12-125" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb12-126"><a href="#cb12-126" aria-hidden="true" tabindex="-1"></a>        logger.error(<span class="ss">f"Erreur lors de la prediction : </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb12-127"><a href="#cb12-127" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> HTTPException(</span>
<span id="cb12-128"><a href="#cb12-128" aria-hidden="true" tabindex="-1"></a>            status_code<span class="op">=</span><span class="dv">500</span>, </span>
<span id="cb12-129"><a href="#cb12-129" aria-hidden="true" tabindex="-1"></a>            detail<span class="op">=</span><span class="ss">f"Erreur de prediction : </span><span class="sc">{</span><span class="bu">str</span>(e)<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb12-130"><a href="#cb12-130" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb12-131"><a href="#cb12-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-132"><a href="#cb12-132" aria-hidden="true" tabindex="-1"></a><span class="at">@app.post</span>(<span class="st">"/predict/batch"</span>, tags<span class="op">=</span>[<span class="st">"Prediction"</span>])</span>
<span id="cb12-133"><a href="#cb12-133" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> predict_batch(features_list: List[CustomerFeatures]):</span>
<span id="cb12-134"><a href="#cb12-134" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb12-135"><a href="#cb12-135" aria-hidden="true" tabindex="-1"></a><span class="co">    Predictions en batch pour plusieurs clients</span></span>
<span id="cb12-136"><a href="#cb12-136" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb12-137"><a href="#cb12-137" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> model <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb12-138"><a href="#cb12-138" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> HTTPException(status_code<span class="op">=</span><span class="dv">503</span>, detail<span class="op">=</span><span class="st">"Modele non disponible"</span>)</span>
<span id="cb12-139"><a href="#cb12-139" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-140"><a href="#cb12-140" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb12-141"><a href="#cb12-141" aria-hidden="true" tabindex="-1"></a>        predictions <span class="op">=</span> []</span>
<span id="cb12-142"><a href="#cb12-142" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-143"><a href="#cb12-143" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> features <span class="kw">in</span> features_list:</span>
<span id="cb12-144"><a href="#cb12-144" aria-hidden="true" tabindex="-1"></a>            input_data <span class="op">=</span> np.array([[</span>
<span id="cb12-145"><a href="#cb12-145" aria-hidden="true" tabindex="-1"></a>                features.CreditScore, features.Age, features.Tenure,</span>
<span id="cb12-146"><a href="#cb12-146" aria-hidden="true" tabindex="-1"></a>                features.Balance, features.NumOfProducts, features.HasCrCard,</span>
<span id="cb12-147"><a href="#cb12-147" aria-hidden="true" tabindex="-1"></a>                features.IsActiveMember, features.EstimatedSalary,</span>
<span id="cb12-148"><a href="#cb12-148" aria-hidden="true" tabindex="-1"></a>                features.Geography_Germany, features.Geography_Spain</span>
<span id="cb12-149"><a href="#cb12-149" aria-hidden="true" tabindex="-1"></a>            ]])</span>
<span id="cb12-150"><a href="#cb12-150" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb12-151"><a href="#cb12-151" aria-hidden="true" tabindex="-1"></a>            proba <span class="op">=</span> model.predict_proba(input_data)[<span class="dv">0</span>, <span class="dv">1</span>]</span>
<span id="cb12-152"><a href="#cb12-152" aria-hidden="true" tabindex="-1"></a>            prediction <span class="op">=</span> <span class="bu">int</span>(proba <span class="op">&gt;</span> <span class="fl">0.5</span>)</span>
<span id="cb12-153"><a href="#cb12-153" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb12-154"><a href="#cb12-154" aria-hidden="true" tabindex="-1"></a>            predictions.append({</span>
<span id="cb12-155"><a href="#cb12-155" aria-hidden="true" tabindex="-1"></a>                <span class="st">"churn_probability"</span>: <span class="bu">round</span>(<span class="bu">float</span>(proba), <span class="dv">4</span>),</span>
<span id="cb12-156"><a href="#cb12-156" aria-hidden="true" tabindex="-1"></a>                <span class="st">"prediction"</span>: prediction</span>
<span id="cb12-157"><a href="#cb12-157" aria-hidden="true" tabindex="-1"></a>            })</span>
<span id="cb12-158"><a href="#cb12-158" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-159"><a href="#cb12-159" aria-hidden="true" tabindex="-1"></a>        logger.info(<span class="ss">f"Batch prediction : </span><span class="sc">{</span><span class="bu">len</span>(predictions)<span class="sc">}</span><span class="ss"> clients traites"</span>)</span>
<span id="cb12-160"><a href="#cb12-160" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb12-161"><a href="#cb12-161" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {<span class="st">"predictions"</span>: predictions, <span class="st">"count"</span>: <span class="bu">len</span>(predictions)}</span>
<span id="cb12-162"><a href="#cb12-162" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-163"><a href="#cb12-163" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb12-164"><a href="#cb12-164" aria-hidden="true" tabindex="-1"></a>        logger.error(<span class="ss">f"Erreur batch prediction : </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb12-165"><a href="#cb12-165" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> HTTPException(status_code<span class="op">=</span><span class="dv">500</span>, detail<span class="op">=</span><span class="bu">str</span>(e))</span>
<span id="cb12-166"><a href="#cb12-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-167"><a href="#cb12-167" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb12-168"><a href="#cb12-168" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> uvicorn</span>
<span id="cb12-169"><a href="#cb12-169" aria-hidden="true" tabindex="-1"></a>    uvicorn.run(app, host<span class="op">=</span><span class="st">"0.0.0.0"</span>, port<span class="op">=</span><span class="dv">8000</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="sec-module2-test" class="level3" data-number="4.5">
<h3 data-number="4.5" class="anchored" data-anchor-id="sec-module2-test"><span class="header-section-number">4.5</span> Test Local de l’API</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb13"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Demarrer l'API</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="ex">uvicorn</span> app.main:app <span class="at">--reload</span> <span class="at">--port</span> 8000</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Dans un autre terminal, tester :</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Health check</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="ex">curl</span> http://localhost:8000/health</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Prediction simple</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a><span class="ex">curl</span> <span class="at">-X</span> POST <span class="st">"http://localhost:8000/predict"</span> <span class="dt">\</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">-H</span> <span class="st">"Content-Type: application/json"</span> <span class="dt">\</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">-d</span> <span class="st">'{</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a><span class="st">    "CreditScore": 650,</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a><span class="st">    "Age": 35,</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a><span class="st">    "Tenure": 5,</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a><span class="st">    "Balance": 50000,</span></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a><span class="st">    "NumOfProducts": 2,</span></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a><span class="st">    "HasCrCard": 1,</span></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a><span class="st">    "IsActiveMember": 1,</span></span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a><span class="st">    "EstimatedSalary": 75000,</span></span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a><span class="st">    "Geography_Germany": 0,</span></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a><span class="st">    "Geography_Spain": 1</span></span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a><span class="st">  }'</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="sec-module2-docs" class="level3" data-number="4.6">
<h3 data-number="4.6" class="anchored" data-anchor-id="sec-module2-docs"><span class="header-section-number">4.6</span> Documentation Interactive</h3>
<p>Ouvrez votre navigateur et allez sur :</p>
<ul>
<li><strong>Swagger UI</strong> : http://localhost:8000/docs</li>
<li><strong>ReDoc</strong> : http://localhost:8000/redoc</li>
</ul>
</section>
<section id="sec-module2-checkpoint" class="level3" data-number="4.7">
<h3 data-number="4.7" class="anchored" data-anchor-id="sec-module2-checkpoint"><span class="header-section-number">4.7</span> Checkpoint</h3>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Validation Module 2
</div>
</div>
<div class="callout-body-container callout-body">
<p>Avant de passer au module suivant, vérifiez que :</p>
<div style="margin-left: 20px;">
<ul class="task-list">
<li><label><input type="checkbox">Le modèle est entraîné avec une accuracy &gt; 0.75</label></li>
<li><label><input type="checkbox">Le fichier <code>model/churn_model.pkl</code> existe<br>
</label></li>
<li><label><input type="checkbox">MLflow UI affiche votre expérience</label></li>
<li><label><input type="checkbox">Vous comprenez les métriques obtenues</label></li>
</ul>
</div>
</div>
</div>
</section>
</section>
<section id="sec-module3" class="level2" data-number="5">
<h2 data-number="5" class="anchored" data-anchor-id="sec-module3"><span class="header-section-number">5</span> Module 3 : Conteneurisation avec Docker</h2>
<section id="sec-module3-objectif" class="level3" data-number="5.1">
<h3 data-number="5.1" class="anchored" data-anchor-id="sec-module3-objectif"><span class="header-section-number">5.1</span> Objectif</h3>
<p>Empaqueter l’API dans un conteneur Docker pour la rendre portable et faciliter le déploiement sur Azure.</p>
</section>
<section id="sec-module3-dockerfile" class="level3" data-number="5.2">
<h3 data-number="5.2" class="anchored" data-anchor-id="sec-module3-dockerfile"><span class="header-section-number">5.2</span> Création du Dockerfile</h3>
<p>Créez le fichier <code>Dockerfile</code> à la racine du projet :</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb14"><pre class="sourceCode dockerfile code-with-copy"><code class="sourceCode dockerfile"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Utilise une image Python officielle</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="kw">FROM</span> python:3.9-slim</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Definir le repertoire de travail</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="kw">WORKDIR</span> /app</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Copier les fichiers de dependances</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="kw">COPY</span> requirements.txt .</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Installer les dependances</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a><span class="kw">RUN</span> <span class="ex">pip</span> install <span class="at">--no-cache-dir</span> <span class="at">-r</span> requirements.txt</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Copier le code de l'application</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a><span class="kw">COPY</span> app/ ./app/</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a><span class="kw">COPY</span> model/ ./model/</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Exposer le port</span></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a><span class="kw">EXPOSE</span> 8000</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Commande pour demarrer l'application</span></span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a><span class="kw">CMD</span> [<span class="st">"uvicorn"</span>, <span class="st">"app.main:app"</span>, <span class="st">"--host"</span>, <span class="st">"0.0.0.0"</span>, <span class="st">"--port"</span>, <span class="st">"8000"</span>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="sec-module3-dockerignore" class="level3" data-number="5.3">
<h3 data-number="5.3" class="anchored" data-anchor-id="sec-module3-dockerignore"><span class="header-section-number">5.3</span> Création du .dockerignore</h3>
<p>Créez le fichier <code>.dockerignore</code> :</p>
<pre><code>__pycache__
*.pyc
*.pyo
*.pyd
.Python
env/
venv/
.venv
*.egg-info/
.pytest_cache/
.git
.gitignore
README.md
.env
mlruns/
*.log
.DS_Store
.vscode/
tests/</code></pre>
</section>
<section id="sec-module3-build" class="level3" data-number="5.4">
<h3 data-number="5.4" class="anchored" data-anchor-id="sec-module3-build"><span class="header-section-number">5.4</span> Build de l’Image Docker</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb16"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Build de l'image (cela peut prendre quelques minutes)</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> build <span class="at">-t</span> bank-churn-api:v1 .</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Verifier que l'image est creee</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> images bank-churn-api:v1</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Voir la taille de l'image</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> images <span class="at">--format</span> <span class="st">"table {{.Repository}}\t{{.Tag}}\t{{.Size}}"</span> <span class="kw">|</span> <span class="fu">grep</span> bank-churn</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="sec-module3-test" class="level3" data-number="5.5">
<h3 data-number="5.5" class="anchored" data-anchor-id="sec-module3-test"><span class="header-section-number">5.5</span> Test du Conteneur en Local</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb17"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Lancer le conteneur</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> run <span class="at">-d</span> <span class="at">-p</span> 8000:8000 <span class="at">--name</span> churn-api bank-churn-api:v1</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Verifier que le conteneur tourne</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> ps</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Voir les logs</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> logs churn-api</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Tester l'API</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a><span class="ex">curl</span> http://localhost:8000/health</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Prediction de test</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a><span class="ex">curl</span> <span class="at">-X</span> POST <span class="st">"http://localhost:8000/predict"</span> <span class="dt">\</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">-H</span> <span class="st">"Content-Type: application/json"</span> <span class="dt">\</span></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">-d</span> <span class="st">'{</span></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a><span class="st">    "CreditScore": 700,</span></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a><span class="st">    "Age": 40,</span></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a><span class="st">    "Tenure": 7,</span></span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a><span class="st">    "Balance": 80000,</span></span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a><span class="st">    "NumOfProducts": 3,</span></span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a><span class="st">    "HasCrCard": 1,</span></span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a><span class="st">    "IsActiveMember": 0,</span></span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a><span class="st">    "EstimatedSalary": 90000,</span></span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a><span class="st">    "Geography_Germany": 1,</span></span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a><span class="st">    "Geography_Spain": 0</span></span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a><span class="st">  }'</span></span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Arreter et supprimer le conteneur</span></span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> stop churn-api</span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> rm churn-api</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="sec-module3-commandes" class="level3" data-number="5.6">
<h3 data-number="5.6" class="anchored" data-anchor-id="sec-module3-commandes"><span class="header-section-number">5.6</span> Commandes Docker Utiles</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb18"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Voir tous les conteneurs (meme arretes)</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> ps <span class="at">-a</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Entrer dans un conteneur en cours d'execution</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> exec <span class="at">-it</span> churn-api /bin/bash</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Voir l'utilisation des ressources</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> stats churn-api</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Nettoyer les images inutilisees</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> image prune</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Supprimer toutes les images</span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> rmi <span class="va">$(</span><span class="ex">docker</span> images <span class="at">-q</span><span class="va">)</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="sec-module3-questions" class="level3" data-number="5.7">
<h3 data-number="5.7" class="anchored" data-anchor-id="sec-module3-questions"><span class="header-section-number">5.7</span> Questions de Compréhension</h3>
<ol type="1">
<li>Pourquoi utiliser un .dockerignore ?</li>
<li>Quelle est la différence entre CMD et RUN dans un Dockerfile ?</li>
<li>Pourquoi exposer le port 8000 ?</li>
<li>Comment vérifier que votre conteneur fonctionne correctement ?</li>
</ol>
</section>
<section id="sec-module3-checkpoint" class="level3" data-number="5.8">
<h3 data-number="5.8" class="anchored" data-anchor-id="sec-module3-checkpoint"><span class="header-section-number">5.8</span> Checkpoint</h3>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Validation Module 3
</div>
</div>
<div class="callout-body-container callout-body">
Avant de passer au module suivant, vérifiez que :
<div style="margin-left: 20px;">
<ul class="task-list">
<li><label><input type="checkbox">L’image Docker est buildée avec succès</label></li>
<li><label><input type="checkbox">Le conteneur démarre sans erreur</label></li>
<li><label><input type="checkbox">L’API répond correctement depuis le conteneur</label></li>
<li><label><input type="checkbox">La taille de l’image est raisonnable (&lt; 1GB)</label></li>
</ul>
</div>
</div>
</div>
</section>
</section>
<section id="sec-module4" class="level2" data-number="6">
<h2 data-number="6" class="anchored" data-anchor-id="sec-module4"><span class="header-section-number">6</span> Module 4 : Déploiement sur Azure</h2>
<section id="sec-module4-objectif" class="level3" data-number="6.1">
<h3 data-number="6.1" class="anchored" data-anchor-id="sec-module4-objectif"><span class="header-section-number">6.1</span> Objectif</h3>
<p>Déployer l’API sur Azure Container Apps et la rendre accessible publiquement.</p>
</section>
<section id="sec-module4-etape1" class="level3" data-number="6.2">
<h3 data-number="6.2" class="anchored" data-anchor-id="sec-module4-etape1"><span class="header-section-number">6.2</span> Étape 1 : Création du Groupe de Ressources</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb19"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Variables (MODIFIEZ avec vos valeurs)</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="va">RESOURCE_GROUP</span><span class="op">=</span><span class="st">"rg-mlops-workshop"</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="va">LOCATION</span><span class="op">=</span><span class="st">"westeurope"</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="va">ACR_NAME</span><span class="op">=</span><span class="st">"acrmlops</span><span class="va">$(</span><span class="fu">whoami</span><span class="va">)$(</span><span class="fu">date</span> +%s<span class="va">)</span><span class="st">"</span>  <span class="co"># Doit etre unique globalement</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="va">CONTAINER_APP_NAME</span><span class="op">=</span><span class="st">"app-churn-api"</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Creation du groupe de ressources</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="ex">az</span> group create <span class="dt">\</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">--name</span> <span class="va">$RESOURCE_GROUP</span> <span class="dt">\</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">--location</span> <span class="va">$LOCATION</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"Groupe de ressources cree : </span><span class="va">$RESOURCE_GROUP</span><span class="st">"</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="sec-module4-etape2" class="level3" data-number="6.3">
<h3 data-number="6.3" class="anchored" data-anchor-id="sec-module4-etape2"><span class="header-section-number">6.3</span> Étape 2 : Azure Container Registry (ACR)</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb20"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Creation du registry (SKU Basic pour economiser)</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="ex">az</span> acr create <span class="dt">\</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">--resource-group</span> <span class="va">$RESOURCE_GROUP</span> <span class="dt">\</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">--name</span> <span class="va">$ACR_NAME</span> <span class="dt">\</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">--sku</span> Basic <span class="dt">\</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">--admin-enabled</span> true</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"Container Registry cree : </span><span class="va">$ACR_NAME</span><span class="st">"</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Se connecter au registry</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a><span class="ex">az</span> acr login <span class="at">--name</span> <span class="va">$ACR_NAME</span></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Verifier la connexion</span></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a><span class="ex">az</span> acr show <span class="at">--name</span> <span class="va">$ACR_NAME</span> <span class="at">--query</span> loginServer <span class="at">--output</span> tsv</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="sec-module4-etape3" class="level3" data-number="6.4">
<h3 data-number="6.4" class="anchored" data-anchor-id="sec-module4-etape3"><span class="header-section-number">6.4</span> Étape 3 : Push de l’Image vers ACR</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb21"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Recuperer l'URL du registry</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="va">ACR_LOGIN_SERVER</span><span class="op">=</span><span class="va">$(</span><span class="ex">az</span> acr show <span class="at">--name</span> <span class="va">$ACR_NAME</span> <span class="at">--query</span> loginServer <span class="at">--output</span> tsv<span class="va">)</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Tagger l'image pour ACR</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> tag bank-churn-api:v1 <span class="va">$ACR_LOGIN_SERVER</span>/bank-churn-api:v1</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> tag bank-churn-api:v1 <span class="va">$ACR_LOGIN_SERVER</span>/bank-churn-api:latest</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Pousser l'image vers ACR</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> push <span class="va">$ACR_LOGIN_SERVER</span>/bank-churn-api:v1</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> push <span class="va">$ACR_LOGIN_SERVER</span>/bank-churn-api:latest</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Verifier que l'image est bien dans ACR</span></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a><span class="ex">az</span> acr repository list <span class="at">--name</span> <span class="va">$ACR_NAME</span> <span class="at">--output</span> table</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a><span class="ex">az</span> acr repository show-tags <span class="at">--name</span> <span class="va">$ACR_NAME</span> <span class="at">--repository</span> bank-churn-api <span class="at">--output</span> table</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="sec-module4-etape4" class="level3" data-number="6.5">
<h3 data-number="6.5" class="anchored" data-anchor-id="sec-module4-etape4"><span class="header-section-number">6.5</span> Étape 4 : Création de l’Environnement Container Apps</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb22"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Variables</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="va">CONTAINERAPPS_ENV</span><span class="op">=</span><span class="st">"env-mlops-workshop"</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Creation de l'environnement</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="ex">az</span> containerapp env create <span class="dt">\</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">--name</span> <span class="va">$CONTAINERAPPS_ENV</span> <span class="dt">\</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">--resource-group</span> <span class="va">$RESOURCE_GROUP</span> <span class="dt">\</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">--location</span> <span class="va">$LOCATION</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"Environnement Container Apps cree : </span><span class="va">$CONTAINERAPPS_ENV</span><span class="st">"</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="sec-module4-etape5" class="level3" data-number="6.6">
<h3 data-number="6.6" class="anchored" data-anchor-id="sec-module4-etape5"><span class="header-section-number">6.6</span> Étape 5 : Déploiement de l’Application</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb23"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Recuperer les credentials ACR</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="va">ACR_USERNAME</span><span class="op">=</span><span class="va">$(</span><span class="ex">az</span> acr credential show <span class="at">--name</span> <span class="va">$ACR_NAME</span> <span class="at">--query</span> username <span class="at">-o</span> tsv<span class="va">)</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="va">ACR_PASSWORD</span><span class="op">=</span><span class="va">$(</span><span class="ex">az</span> acr credential show <span class="at">--name</span> <span class="va">$ACR_NAME</span> <span class="at">--query</span> passwords<span class="pp">[</span><span class="ss">0</span><span class="pp">]</span>.value <span class="at">-o</span> tsv<span class="va">)</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Deployer l'application</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a><span class="ex">az</span> containerapp create <span class="dt">\</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">--name</span> <span class="va">$CONTAINER_APP_NAME</span> <span class="dt">\</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">--resource-group</span> <span class="va">$RESOURCE_GROUP</span> <span class="dt">\</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">--environment</span> <span class="va">$CONTAINERAPPS_ENV</span> <span class="dt">\</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">--image</span> <span class="va">$ACR_LOGIN_SERVER</span>/bank-churn-api:v1 <span class="dt">\</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">--registry-server</span> <span class="va">$ACR_LOGIN_SERVER</span> <span class="dt">\</span></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">--registry-username</span> <span class="va">$ACR_USERNAME</span> <span class="dt">\</span></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">--registry-password</span> <span class="va">$ACR_PASSWORD</span> <span class="dt">\</span></span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">--target-port</span> 8000 <span class="dt">\</span></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">--ingress</span> external <span class="dt">\</span></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">--min-replicas</span> 1 <span class="dt">\</span></span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">--max-replicas</span> 3 <span class="dt">\</span></span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">--cpu</span> 0.5 <span class="dt">\</span></span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">--memory</span> 1Gi</span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"Application deployee !"</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="sec-module4-etape6" class="level3" data-number="6.7">
<h3 data-number="6.7" class="anchored" data-anchor-id="sec-module4-etape6"><span class="header-section-number">6.7</span> Étape 6 : Récupérer l’URL Publique</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb24"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Recuperer l'URL de l'application</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="va">APP_URL</span><span class="op">=</span><span class="va">$(</span><span class="ex">az</span> containerapp show <span class="dt">\</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">--name</span> <span class="va">$CONTAINER_APP_NAME</span> <span class="dt">\</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">--resource-group</span> <span class="va">$RESOURCE_GROUP</span> <span class="dt">\</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">--query</span> properties.configuration.ingress.fqdn <span class="at">-o</span> tsv<span class="va">)</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"=========================================="</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"API deployee avec succes !"</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"URL : https://</span><span class="va">$APP_URL</span><span class="st">"</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"Health check : https://</span><span class="va">$APP_URL</span><span class="st">/health"</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"Documentation : https://</span><span class="va">$APP_URL</span><span class="st">/docs"</span></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"=========================================="</span></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Tester l'API deployee</span></span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a><span class="ex">curl</span> https://<span class="va">$APP_URL</span>/health</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="sec-module4-etape7" class="level3" data-number="6.8">
<h3 data-number="6.8" class="anchored" data-anchor-id="sec-module4-etape7"><span class="header-section-number">6.8</span> Étape 7 : Test de l’API en Production</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb25"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Test de prediction</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="ex">curl</span> <span class="at">-X</span> POST <span class="st">"https://</span><span class="va">$APP_URL</span><span class="st">/predict"</span> <span class="dt">\</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">-H</span> <span class="st">"Content-Type: application/json"</span> <span class="dt">\</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">-d</span> <span class="st">'{</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="st">    "CreditScore": 650,</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a><span class="st">    "Age": 35,</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a><span class="st">    "Tenure": 5,</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a><span class="st">    "Balance": 50000,</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a><span class="st">    "NumOfProducts": 2,</span></span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a><span class="st">    "HasCrCard": 1,</span></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a><span class="st">    "IsActiveMember": 1,</span></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a><span class="st">    "EstimatedSalary": 75000,</span></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a><span class="st">    "Geography_Germany": 0,</span></span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a><span class="st">    "Geography_Spain": 1</span></span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a><span class="st">  }'</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="sec-module4-couts" class="level3" data-number="6.9">
<h3 data-number="6.9" class="anchored" data-anchor-id="sec-module4-couts"><span class="header-section-number">6.9</span> Surveillance des Coûts</h3>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Warning</span>IMPORTANT - Gestion du Budget
</div>
</div>
<div class="callout-body-container callout-body">
<p>Pour éviter de dépasser le budget de 100$ :</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb26"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Voir les couts estimes</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="ex">az</span> consumption usage list <span class="dt">\</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">--start-date</span> 2024-11-01 <span class="dt">\</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">--end-date</span> 2024-11-30 <span class="dt">\</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">--output</span> table</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Mettre l'application en veille (min-replicas=0)</span></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a><span class="ex">az</span> containerapp update <span class="dt">\</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">--name</span> <span class="va">$CONTAINER_APP_NAME</span> <span class="dt">\</span></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">--resource-group</span> <span class="va">$RESOURCE_GROUP</span> <span class="dt">\</span></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">--min-replicas</span> 0 <span class="dt">\</span></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">--max-replicas</span> 3</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Coûts estimés pour ce workshop : 8-12$ pour 10 heures d’utilisation.</p>
</div>
</div>
</section>
<section id="sec-module4-exercice" class="level3" data-number="6.10">
<h3 data-number="6.10" class="anchored" data-anchor-id="sec-module4-exercice"><span class="header-section-number">6.10</span> Exercice Pratique</h3>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Tip</span>EXERCICE 2
</div>
</div>
<div class="callout-body-container callout-body">
<p>Partagez votre URL d’API avec un camarade et testez son API :</p>
<ol type="1">
<li>Faites 10 prédictions sur son API</li>
<li>Comparez les résultats avec votre modèle</li>
<li>Observez les logs dans Azure Portal</li>
</ol>
</div>
</div>
</section>
<section id="sec-module4-checkpoint" class="level3" data-number="6.11">
<h3 data-number="6.11" class="anchored" data-anchor-id="sec-module4-checkpoint"><span class="header-section-number">6.11</span> Checkpoint</h3>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Validation Module 4
</div>
</div>
<div class="callout-body-container callout-body">
Avant de passer au module suivant, vérifiez que :
<div style="margin-left: 20px;">
<ul class="task-list">
<li><label><input type="checkbox">L’application est accessible via HTTPS</label></li>
<li><label><input type="checkbox">Le health check fonctionne</label></li>
<li><label><input type="checkbox">Les prédictions fonctionnent</label></li>
<li><label><input type="checkbox">Vous avez noté l’URL publique de votre API</label></li>
</ul>
</div>
</div>
</div>
</section>
</section>
<section id="sec-module5" class="level2" data-number="7">
<h2 data-number="7" class="anchored" data-anchor-id="sec-module5"><span class="header-section-number">7</span> Module 5 : CI/CD avec GitHub Actions</h2>
<section id="sec-module5-objectif" class="level3" data-number="7.1">
<h3 data-number="7.1" class="anchored" data-anchor-id="sec-module5-objectif"><span class="header-section-number">7.1</span> Objectif</h3>
<p>Automatiser le déploiement : chaque commit sur la branche main déclenche un build et un redéploiement.</p>
</section>
<section id="sec-module5-etape1" class="level3" data-number="7.2">
<h3 data-number="7.2" class="anchored" data-anchor-id="sec-module5-etape1"><span class="header-section-number">7.2</span> Étape 1 : Initialisation du Repository Git</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb27"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialiser git (si pas deja fait)</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> init</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Creer un .gitignore</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> <span class="op">&gt;</span> .gitignore <span class="op">&lt;&lt; EOF</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a><span class="st">__pycache__/</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a><span class="st">*.pyc</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a><span class="st">venv/</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a><span class="st">.env</span></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a><span class="st">mlruns/</span></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a><span class="st">*.log</span></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a><span class="st">.DS_Store</span></span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a><span class="st">.vscode/</span></span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a><span class="st">confusion_matrix.png</span></span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a><span class="st">feature_importance.png</span></span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a><span class="op">EOF</span></span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Premier commit</span></span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> add .</span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> commit <span class="at">-m</span> <span class="st">"Initial commit: Bank Churn API"</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="sec-module5-etape2" class="level3" data-number="7.3">
<h3 data-number="7.3" class="anchored" data-anchor-id="sec-module5-etape2"><span class="header-section-number">7.3</span> Étape 2 : Créer un Repository GitHub</h3>
<ol type="1">
<li>Allez sur https://github.com/new</li>
<li>Nom du repository : <code>bank-churn-mlops</code></li>
<li>Visibility : Public ou Private</li>
<li>Ne pas initialiser avec README (déjà fait localement)</li>
<li>Cliquez sur “Create repository”</li>
</ol>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb28"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Lier votre repo local a GitHub (REMPLACEZ username)</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> remote add origin https://github.com/username/bank-churn-mlops.git</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> branch <span class="at">-M</span> main</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> push <span class="at">-u</span> origin main</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="sec-module5-etape3" class="level3" data-number="7.4">
<h3 data-number="7.4" class="anchored" data-anchor-id="sec-module5-etape3"><span class="header-section-number">7.4</span> Étape 3 : Configuration des Secrets GitHub</h3>
<section id="sec-module5-service-principal" class="level4" data-number="7.4.1">
<h4 data-number="7.4.1" class="anchored" data-anchor-id="sec-module5-service-principal"><span class="header-section-number">7.4.1</span> Créer un Service Principal Azure</h4>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb29"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Recuperer votre Subscription ID</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="va">SUBSCRIPTION_ID</span><span class="op">=</span><span class="va">$(</span><span class="ex">az</span> account show <span class="at">--query</span> id <span class="at">-o</span> tsv<span class="va">)</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Creer un Service Principal</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="ex">az</span> ad sp create-for-rbac <span class="dt">\</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">--name</span> <span class="st">"github-actions-mlops"</span> <span class="dt">\</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">--role</span> contributor <span class="dt">\</span></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">--scopes</span> /subscriptions/<span class="va">$SUBSCRIPTION_ID</span>/resourceGroups/<span class="va">$RESOURCE_GROUP</span> <span class="dt">\</span></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">--sdk-auth</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Copiez tout le JSON retourné.</p>
</section>
<section id="sec-module5-secrets" class="level4" data-number="7.4.2">
<h4 data-number="7.4.2" class="anchored" data-anchor-id="sec-module5-secrets"><span class="header-section-number">7.4.2</span> Ajouter les Secrets dans GitHub</h4>
<ol type="1">
<li>Allez dans votre repository GitHub</li>
<li>Settings &gt; Secrets and variables &gt; Actions</li>
<li>Cliquez sur “New repository secret”</li>
<li>Ajoutez les secrets suivants :</li>
</ol>
<table class="caption-top table">
<colgroup>
<col style="width: 42%">
<col style="width: 57%">
</colgroup>
<thead>
<tr class="header">
<th><strong>Nom</strong></th>
<th><strong>Valeur</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>AZURE_CREDENTIALS</td>
<td>Le JSON du Service Principal</td>
</tr>
<tr class="even">
<td>ACR_USERNAME</td>
<td>Résultat de : <code>az acr credential show --name $ACR_NAME --query username -o tsv</code></td>
</tr>
<tr class="odd">
<td>ACR_PASSWORD</td>
<td>Résultat de : <code>az acr credential show --name $ACR_NAME --query passwords[0].value -o tsv</code></td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="sec-module5-etape4" class="level3" data-number="7.5">
<h3 data-number="7.5" class="anchored" data-anchor-id="sec-module5-etape4"><span class="header-section-number">7.5</span> Étape 4 : Création du Workflow GitHub Actions</h3>
<p>Créez le fichier <code>.github/workflows/ci-cd.yml</code> :</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb30"><pre class="sourceCode yaml code-with-copy"><code class="sourceCode yaml"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="fu">name</span><span class="kw">:</span><span class="at"> CI/CD Pipeline</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="fu">on</span><span class="kw">:</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">push</span><span class="kw">:</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">branches</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="at"> main </span><span class="kw">]</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">pull_request</span><span class="kw">:</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">branches</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="at"> main </span><span class="kw">]</span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">workflow_dispatch</span><span class="kw">:</span></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a><span class="fu">env</span><span class="kw">:</span></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">AZURE_RESOURCE_GROUP</span><span class="kw">:</span><span class="at"> rg-mlops-workshop</span></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">ACR_NAME</span><span class="kw">:</span><span class="at"> votre-acr-name</span><span class="co">  # MODIFIEZ ICI</span></span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">CONTAINER_APP_NAME</span><span class="kw">:</span><span class="at"> app-churn-api</span></span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">IMAGE_NAME</span><span class="kw">:</span><span class="at"> bank-churn-api</span></span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a><span class="fu">jobs</span><span class="kw">:</span></span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">test</span><span class="kw">:</span></span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">runs-on</span><span class="kw">:</span><span class="at"> ubuntu-latest</span></span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a><span class="at">    </span></span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">steps</span><span class="kw">:</span></span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Checkout code</span></span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> actions/checkout@v3</span></span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a><span class="at">      </span></span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Set up Python</span></span>
<span id="cb30-25"><a href="#cb30-25" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> actions/setup-python@v4</span></span>
<span id="cb30-26"><a href="#cb30-26" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">with</span><span class="kw">:</span></span>
<span id="cb30-27"><a href="#cb30-27" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">python-version</span><span class="kw">:</span><span class="at"> </span><span class="st">'3.9'</span></span>
<span id="cb30-28"><a href="#cb30-28" aria-hidden="true" tabindex="-1"></a><span class="at">      </span></span>
<span id="cb30-29"><a href="#cb30-29" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Install dependencies</span></span>
<span id="cb30-30"><a href="#cb30-30" aria-hidden="true" tabindex="-1"></a><span class="fu">        run</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb30-31"><a href="#cb30-31" aria-hidden="true" tabindex="-1"></a>          python -m pip install --upgrade pip</span>
<span id="cb30-32"><a href="#cb30-32" aria-hidden="true" tabindex="-1"></a>          pip install -r requirements.txt</span>
<span id="cb30-33"><a href="#cb30-33" aria-hidden="true" tabindex="-1"></a>          pip install pytest pytest-cov</span>
<span id="cb30-34"><a href="#cb30-34" aria-hidden="true" tabindex="-1"></a><span class="at">      </span></span>
<span id="cb30-35"><a href="#cb30-35" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Run tests</span></span>
<span id="cb30-36"><a href="#cb30-36" aria-hidden="true" tabindex="-1"></a><span class="fu">        run</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb30-37"><a href="#cb30-37" aria-hidden="true" tabindex="-1"></a>          pytest tests/ -v --cov=app --cov-report=term</span>
<span id="cb30-38"><a href="#cb30-38" aria-hidden="true" tabindex="-1"></a><span class="at">      </span></span>
<span id="cb30-39"><a href="#cb30-39" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">build-and-deploy</span><span class="kw">:</span></span>
<span id="cb30-40"><a href="#cb30-40" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">needs</span><span class="kw">:</span><span class="at"> test</span></span>
<span id="cb30-41"><a href="#cb30-41" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">runs-on</span><span class="kw">:</span><span class="at"> ubuntu-latest</span></span>
<span id="cb30-42"><a href="#cb30-42" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">if</span><span class="kw">:</span><span class="at"> github.ref == 'refs/heads/main'</span></span>
<span id="cb30-43"><a href="#cb30-43" aria-hidden="true" tabindex="-1"></a><span class="at">    </span></span>
<span id="cb30-44"><a href="#cb30-44" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">steps</span><span class="kw">:</span></span>
<span id="cb30-45"><a href="#cb30-45" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Checkout code</span></span>
<span id="cb30-46"><a href="#cb30-46" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> actions/checkout@v3</span></span>
<span id="cb30-47"><a href="#cb30-47" aria-hidden="true" tabindex="-1"></a><span class="at">      </span></span>
<span id="cb30-48"><a href="#cb30-48" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Azure Login</span></span>
<span id="cb30-49"><a href="#cb30-49" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> azure/login@v1</span></span>
<span id="cb30-50"><a href="#cb30-50" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">with</span><span class="kw">:</span></span>
<span id="cb30-51"><a href="#cb30-51" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">creds</span><span class="kw">:</span><span class="at"> ${{ secrets.AZURE_CREDENTIALS }}</span></span>
<span id="cb30-52"><a href="#cb30-52" aria-hidden="true" tabindex="-1"></a><span class="at">      </span></span>
<span id="cb30-53"><a href="#cb30-53" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Login to ACR</span></span>
<span id="cb30-54"><a href="#cb30-54" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> azure/docker-login@v1</span></span>
<span id="cb30-55"><a href="#cb30-55" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">with</span><span class="kw">:</span></span>
<span id="cb30-56"><a href="#cb30-56" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">login-server</span><span class="kw">:</span><span class="at"> ${{ env.ACR_NAME }}.azurecr.io</span></span>
<span id="cb30-57"><a href="#cb30-57" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">username</span><span class="kw">:</span><span class="at"> ${{ secrets.ACR_USERNAME }}</span></span>
<span id="cb30-58"><a href="#cb30-58" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">password</span><span class="kw">:</span><span class="at"> ${{ secrets.ACR_PASSWORD }}</span></span>
<span id="cb30-59"><a href="#cb30-59" aria-hidden="true" tabindex="-1"></a><span class="at">      </span></span>
<span id="cb30-60"><a href="#cb30-60" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Build and push Docker image</span></span>
<span id="cb30-61"><a href="#cb30-61" aria-hidden="true" tabindex="-1"></a><span class="fu">        run</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb30-62"><a href="#cb30-62" aria-hidden="true" tabindex="-1"></a>          docker build -t ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }} .</span>
<span id="cb30-63"><a href="#cb30-63" aria-hidden="true" tabindex="-1"></a>          docker build -t ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:latest .</span>
<span id="cb30-64"><a href="#cb30-64" aria-hidden="true" tabindex="-1"></a>          docker push ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }}</span>
<span id="cb30-65"><a href="#cb30-65" aria-hidden="true" tabindex="-1"></a>          docker push ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:latest</span>
<span id="cb30-66"><a href="#cb30-66" aria-hidden="true" tabindex="-1"></a><span class="at">      </span></span>
<span id="cb30-67"><a href="#cb30-67" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Deploy to Azure Container Apps</span></span>
<span id="cb30-68"><a href="#cb30-68" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> azure/CLI@v1</span></span>
<span id="cb30-69"><a href="#cb30-69" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">with</span><span class="kw">:</span></span>
<span id="cb30-70"><a href="#cb30-70" aria-hidden="true" tabindex="-1"></a><span class="fu">          inlineScript</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb30-71"><a href="#cb30-71" aria-hidden="true" tabindex="-1"></a>            az containerapp update \</span>
<span id="cb30-72"><a href="#cb30-72" aria-hidden="true" tabindex="-1"></a>              --name ${{ env.CONTAINER_APP_NAME }} \</span>
<span id="cb30-73"><a href="#cb30-73" aria-hidden="true" tabindex="-1"></a>              --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \</span>
<span id="cb30-74"><a href="#cb30-74" aria-hidden="true" tabindex="-1"></a>              --image ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME }}:${{ github.sha }}</span>
<span id="cb30-75"><a href="#cb30-75" aria-hidden="true" tabindex="-1"></a><span class="at">      </span></span>
<span id="cb30-76"><a href="#cb30-76" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Verify deployment</span></span>
<span id="cb30-77"><a href="#cb30-77" aria-hidden="true" tabindex="-1"></a><span class="fu">        run</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb30-78"><a href="#cb30-78" aria-hidden="true" tabindex="-1"></a>          APP_URL=$(az containerapp show \</span>
<span id="cb30-79"><a href="#cb30-79" aria-hidden="true" tabindex="-1"></a>            --name ${{ env.CONTAINER_APP_NAME }} \</span>
<span id="cb30-80"><a href="#cb30-80" aria-hidden="true" tabindex="-1"></a>            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \</span>
<span id="cb30-81"><a href="#cb30-81" aria-hidden="true" tabindex="-1"></a>            --query properties.configuration.ingress.fqdn -o tsv)</span>
<span id="cb30-82"><a href="#cb30-82" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb30-83"><a href="#cb30-83" aria-hidden="true" tabindex="-1"></a>          echo "Application deployed at: https://$APP_URL"</span>
<span id="cb30-84"><a href="#cb30-84" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb30-85"><a href="#cb30-85" aria-hidden="true" tabindex="-1"></a>          sleep 30</span>
<span id="cb30-86"><a href="#cb30-86" aria-hidden="true" tabindex="-1"></a>          curl -f https://$APP_URL/health || exit 1</span>
<span id="cb30-87"><a href="#cb30-87" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb30-88"><a href="#cb30-88" aria-hidden="true" tabindex="-1"></a>          echo "Deployment successful!"</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="sec-module5-etape5" class="level3" data-number="7.6">
<h3 data-number="7.6" class="anchored" data-anchor-id="sec-module5-etape5"><span class="header-section-number">7.6</span> Étape 5 : Déclencher le Pipeline</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb31"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Ajouter le workflow</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> add .github/workflows/ci-cd.yml</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> add tests/test_api.py</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> commit <span class="at">-m</span> <span class="st">"Add CI/CD pipeline and tests"</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a><span class="fu">git</span> push origin main</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Le pipeline se declenche automatiquement !</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Allez sur GitHub &gt; Actions pour voir le pipeline en cours d’exécution.</p>
</section>
<section id="sec-module5-exercice" class="level3" data-number="7.7">
<h3 data-number="7.7" class="anchored" data-anchor-id="sec-module5-exercice"><span class="header-section-number">7.7</span> Exercice Pratique</h3>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Tip</span>EXERCICE 3
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li>Ajoutez un nouveau test dans <code>test_api.py</code></li>
<li>Faites un commit et push</li>
<li>Observez le pipeline s’exécuter</li>
<li>Vérifiez que le déploiement s’est bien fait</li>
</ol>
</div>
</div>
</section>
<section id="sec-module5-checkpoint" class="level3" data-number="7.8">
<h3 data-number="7.8" class="anchored" data-anchor-id="sec-module5-checkpoint"><span class="header-section-number">7.8</span> Checkpoint</h3>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Validation Module 5
</div>
</div>
<div class="callout-body-container callout-body">
Avant de passer au module suivant, vérifiez que :
<div style="margin-left: 20px; line-height: 1.8;">
<ul class="task-list">
<li><label><input type="checkbox">Le repository GitHub est créé</label></li>
<li><label><input type="checkbox">Les secrets sont configurés</label></li>
<li><label><input type="checkbox">Le workflow CI/CD s’exécute sans erreur</label></li>
<li><label><input type="checkbox">L’application se redéploie</label></li>
</ul>
</div>
<p>automatiquement</p>
</div>
</div>
</section>
</section>
<section id="sec-module6" class="level2" data-number="8">
<h2 data-number="8" class="anchored" data-anchor-id="sec-module6"><span class="header-section-number">8</span> Module 6 : Monitoring et Maintenance</h2>
<section id="sec-module6-objectif" class="level3" data-number="8.1">
<h3 data-number="8.1" class="anchored" data-anchor-id="sec-module6-objectif"><span class="header-section-number">8.1</span> Objectif</h3>
<p>Mettre en place le monitoring de l’application et détecter les problèmes en production.</p>
</section>
<section id="sec-module6-appinsights" class="level3" data-number="8.2">
<h3 data-number="8.2" class="anchored" data-anchor-id="sec-module6-appinsights"><span class="header-section-number">8.2</span> Configuration Application Insights</h3>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb32"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Creation d'Application Insights</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="ex">az</span> monitor app-insights component create <span class="dt">\</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">--app</span> bank-churn-insights <span class="dt">\</span></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">--location</span> <span class="va">$LOCATION</span> <span class="dt">\</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">--resource-group</span> <span class="va">$RESOURCE_GROUP</span> <span class="dt">\</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">--application-type</span> web</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Recuperer la connection string</span></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a><span class="va">APPINSIGHTS_CONN</span><span class="op">=</span><span class="va">$(</span><span class="ex">az</span> monitor app-insights component show <span class="dt">\</span></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">--app</span> bank-churn-insights <span class="dt">\</span></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">--resource-group</span> <span class="va">$RESOURCE_GROUP</span> <span class="dt">\</span></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">--query</span> connectionString <span class="at">-o</span> tsv<span class="va">)</span></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"Connection String : </span><span class="va">$APPINSIGHTS_CONN</span><span class="st">"</span></span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Ajouter la variable d'environnement a Container Apps</span></span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a><span class="ex">az</span> containerapp update <span class="dt">\</span></span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">--name</span> <span class="va">$CONTAINER_APP_NAME</span> <span class="dt">\</span></span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">--resource-group</span> <span class="va">$RESOURCE_GROUP</span> <span class="dt">\</span></span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">--set-env-vars</span> <span class="st">"APPLICATIONINSIGHTS_CONNECTION_STRING=</span><span class="va">$APPINSIGHTS_CONN</span><span class="st">"</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="sec-module6-monitoring" class="level3" data-number="8.3">
<h3 data-number="8.3" class="anchored" data-anchor-id="sec-module6-monitoring"><span class="header-section-number">8.3</span> Intégration du Monitoring dans le Code</h3>
<p>Ajoutez dans <code>requirements.txt</code> :</p>
<pre><code>opencensus-ext-azure==1.1.9
opencensus-ext-requests==0.12.1</code></pre>
<p>Modifiez <code>app/main.py</code> pour ajouter le monitoring :</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> opencensus.ext.azure.log_exporter <span class="im">import</span> AzureLogHandler</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> logging</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Configuration du logging avec Application Insights</span></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>logger <span class="op">=</span> logging.getLogger(<span class="va">__name__</span>)</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>logger.setLevel(logging.INFO)</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>APPINSIGHTS_CONN <span class="op">=</span> os.getenv(<span class="st">"APPLICATIONINSIGHTS_CONNECTION_STRING"</span>)</span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> APPINSIGHTS_CONN:</span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>    logger.addHandler(AzureLogHandler(connection_string<span class="op">=</span>APPINSIGHTS_CONN))</span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>    logger.info(<span class="st">"Application Insights connecte"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="sec-module6-drift" class="level3" data-number="8.4">
<h3 data-number="8.4" class="anchored" data-anchor-id="sec-module6-drift"><span class="header-section-number">8.4</span> Détection de Data Drift</h3>
<p>Créez le fichier <code>drift_detection.py</code> :</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.stats <span class="im">import</span> ks_2samp</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> detect_drift(reference_file, production_file, threshold<span class="op">=</span><span class="fl">0.05</span>):</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a><span class="co">    Detecte le drift entre donnees de reference et production</span></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>    ref_data <span class="op">=</span> pd.read_csv(reference_file)</span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>    prod_data <span class="op">=</span> pd.read_csv(production_file)</span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>    drift_results <span class="op">=</span> {}</span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> column <span class="kw">in</span> ref_data.columns:</span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> column <span class="kw">in</span> prod_data.columns <span class="kw">and</span> column <span class="op">!=</span> <span class="st">'Exited'</span>:</span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Test de Kolmogorov-Smirnov</span></span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a>            statistic, p_value <span class="op">=</span> ks_2samp(</span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a>                ref_data[column].dropna(),</span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a>                prod_data[column].dropna()</span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb35-22"><a href="#cb35-22" aria-hidden="true" tabindex="-1"></a>            drift_detected <span class="op">=</span> p_value <span class="op">&lt;</span> threshold</span>
<span id="cb35-23"><a href="#cb35-23" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb35-24"><a href="#cb35-24" aria-hidden="true" tabindex="-1"></a>            drift_results[column] <span class="op">=</span> {</span>
<span id="cb35-25"><a href="#cb35-25" aria-hidden="true" tabindex="-1"></a>                <span class="st">'p_value'</span>: <span class="bu">float</span>(p_value),</span>
<span id="cb35-26"><a href="#cb35-26" aria-hidden="true" tabindex="-1"></a>                <span class="st">'statistic'</span>: <span class="bu">float</span>(statistic),</span>
<span id="cb35-27"><a href="#cb35-27" aria-hidden="true" tabindex="-1"></a>                <span class="st">'drift_detected'</span>: drift_detected</span>
<span id="cb35-28"><a href="#cb35-28" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb35-29"><a href="#cb35-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb35-30"><a href="#cb35-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Rapport</span></span>
<span id="cb35-31"><a href="#cb35-31" aria-hidden="true" tabindex="-1"></a>    drifted_features <span class="op">=</span> [f <span class="cf">for</span> f, r <span class="kw">in</span> drift_results.items() <span class="cf">if</span> r[<span class="st">'drift_detected'</span>]]</span>
<span id="cb35-32"><a href="#cb35-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb35-33"><a href="#cb35-33" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">50</span>)</span>
<span id="cb35-34"><a href="#cb35-34" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"DATA DRIFT DETECTION REPORT"</span>)</span>
<span id="cb35-35"><a href="#cb35-35" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">50</span>)</span>
<span id="cb35-36"><a href="#cb35-36" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Threshold: </span><span class="sc">{</span>threshold<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb35-37"><a href="#cb35-37" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Features analyzed: </span><span class="sc">{</span><span class="bu">len</span>(drift_results)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb35-38"><a href="#cb35-38" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Features with drift: </span><span class="sc">{</span><span class="bu">len</span>(drifted_features)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb35-39"><a href="#cb35-39" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Drifted features:"</span>)</span>
<span id="cb35-40"><a href="#cb35-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> feature <span class="kw">in</span> drifted_features:</span>
<span id="cb35-41"><a href="#cb35-41" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"  - </span><span class="sc">{</span>feature<span class="sc">}</span><span class="ss">: p-value = </span><span class="sc">{</span>drift_results[feature][<span class="st">'p_value'</span>]<span class="sc">:.4f}</span><span class="ss">"</span>)</span>
<span id="cb35-42"><a href="#cb35-42" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"="</span><span class="op">*</span><span class="dv">50</span>)</span>
<span id="cb35-43"><a href="#cb35-43" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb35-44"><a href="#cb35-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> drift_results</span>
<span id="cb35-45"><a href="#cb35-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-46"><a href="#cb35-46" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="va">__name__</span> <span class="op">==</span> <span class="st">"__main__"</span>:</span>
<span id="cb35-47"><a href="#cb35-47" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> detect_drift(</span>
<span id="cb35-48"><a href="#cb35-48" aria-hidden="true" tabindex="-1"></a>        <span class="st">"data/bank_churn.csv"</span>,</span>
<span id="cb35-49"><a href="#cb35-49" aria-hidden="true" tabindex="-1"></a>        <span class="st">"data/production_data.csv"</span></span>
<span id="cb35-50"><a href="#cb35-50" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb35-51"><a href="#cb35-51" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb35-52"><a href="#cb35-52" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Sauvegarder les resultats</span></span>
<span id="cb35-53"><a href="#cb35-53" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(<span class="st">"drift_report.json"</span>, <span class="st">"w"</span>) <span class="im">as</span> f:</span>
<span id="cb35-54"><a href="#cb35-54" aria-hidden="true" tabindex="-1"></a>        json.dump(results, f, indent<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb35-55"><a href="#cb35-55" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb35-56"><a href="#cb35-56" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Rapport sauvegarde dans drift_report.json"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="sec-module6-checkpoint" class="level3" data-number="8.5">
<h3 data-number="8.5" class="anchored" data-anchor-id="sec-module6-checkpoint"><span class="header-section-number">8.5</span> Checkpoint</h3>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Validation Module 6
</div>
</div>
<div class="callout-body-container callout-body">
Avant de passer au module suivant, vérifiez que :
<div style="margin-left: 20px; line-height: 1.8;">
<ul class="task-list">
<li><label><input type="checkbox">Application Insights est configuré</label></li>
<li><label><input type="checkbox">Les logs apparaissent dans Azure Portal</label></li>
<li><label><input type="checkbox">Vous pouvez visualiser les métriques</label></li>
<li><label><input type="checkbox">Le script de détection de drift fonctionne</label></li>
</ul>
</div>
</div>
</div>
</section>
</section>
<section id="sec-module7" class="level2" data-number="9">
<h2 data-number="9" class="anchored" data-anchor-id="sec-module7"><span class="header-section-number">9</span> Module 7 : Optimisations et Bonnes Pratiques</h2>
<section id="sec-module7-objectif" class="level3" data-number="9.1">
<h3 data-number="9.1" class="anchored" data-anchor-id="sec-module7-objectif"><span class="header-section-number">9.1</span> Objectif</h3>
<p>Améliorer les performances, la sécurité et la maintenabilité de l’application.</p>
</section>
<section id="sec-module7-cache" class="level3" data-number="9.2">
<h3 data-number="9.2" class="anchored" data-anchor-id="sec-module7-cache"><span class="header-section-number">9.2</span> Ajout d’un Cache pour les Prédictions</h3>
<p>Modifiez <code>app/main.py</code> :</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> functools <span class="im">import</span> lru_cache</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> hashlib</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> hash_features(features_dict: <span class="bu">dict</span>) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Cree un hash unique pour les features"""</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> hashlib.md5(</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>        json.dumps(features_dict, sort_keys<span class="op">=</span><span class="va">True</span>).encode()</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>    ).hexdigest()</span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Cache pour les predictions (1000 dernieres)</span></span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a><span class="at">@lru_cache</span>(maxsize<span class="op">=</span><span class="dv">1000</span>)</span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> predict_cached(features_hash: <span class="bu">str</span>, features_json: <span class="bu">str</span>):</span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a>    features_dict <span class="op">=</span> json.loads(features_json)</span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a>    input_data <span class="op">=</span> np.array([[</span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a>        features_dict[<span class="st">"CreditScore"</span>],</span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a>        features_dict[<span class="st">"Age"</span>],</span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a>        <span class="co"># ... autres features</span></span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true" tabindex="-1"></a>    ]])</span>
<span id="cb36-20"><a href="#cb36-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb36-21"><a href="#cb36-21" aria-hidden="true" tabindex="-1"></a>    proba <span class="op">=</span> model.predict_proba(input_data)[<span class="dv">0</span>, <span class="dv">1</span>]</span>
<span id="cb36-22"><a href="#cb36-22" aria-hidden="true" tabindex="-1"></a>    prediction <span class="op">=</span> <span class="bu">int</span>(proba <span class="op">&gt;</span> <span class="fl">0.5</span>)</span>
<span id="cb36-23"><a href="#cb36-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb36-24"><a href="#cb36-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> proba <span class="op">&lt;</span> <span class="fl">0.3</span>:</span>
<span id="cb36-25"><a href="#cb36-25" aria-hidden="true" tabindex="-1"></a>        risk <span class="op">=</span> <span class="st">"Low"</span></span>
<span id="cb36-26"><a href="#cb36-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> proba <span class="op">&lt;</span> <span class="fl">0.7</span>:</span>
<span id="cb36-27"><a href="#cb36-27" aria-hidden="true" tabindex="-1"></a>        risk <span class="op">=</span> <span class="st">"Medium"</span></span>
<span id="cb36-28"><a href="#cb36-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb36-29"><a href="#cb36-29" aria-hidden="true" tabindex="-1"></a>        risk <span class="op">=</span> <span class="st">"High"</span></span>
<span id="cb36-30"><a href="#cb36-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb36-31"><a href="#cb36-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {</span>
<span id="cb36-32"><a href="#cb36-32" aria-hidden="true" tabindex="-1"></a>        <span class="st">"churn_probability"</span>: <span class="bu">round</span>(<span class="bu">float</span>(proba), <span class="dv">4</span>),</span>
<span id="cb36-33"><a href="#cb36-33" aria-hidden="true" tabindex="-1"></a>        <span class="st">"prediction"</span>: prediction,</span>
<span id="cb36-34"><a href="#cb36-34" aria-hidden="true" tabindex="-1"></a>        <span class="st">"risk_level"</span>: risk</span>
<span id="cb36-35"><a href="#cb36-35" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb36-36"><a href="#cb36-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-37"><a href="#cb36-37" aria-hidden="true" tabindex="-1"></a><span class="at">@app.post</span>(<span class="st">"/predict"</span>, response_model<span class="op">=</span>PredictionResponse)</span>
<span id="cb36-38"><a href="#cb36-38" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> predict(features: CustomerFeatures):</span>
<span id="cb36-39"><a href="#cb36-39" aria-hidden="true" tabindex="-1"></a>    features_dict <span class="op">=</span> features.<span class="bu">dict</span>()</span>
<span id="cb36-40"><a href="#cb36-40" aria-hidden="true" tabindex="-1"></a>    features_hash <span class="op">=</span> hash_features(features_dict)</span>
<span id="cb36-41"><a href="#cb36-41" aria-hidden="true" tabindex="-1"></a>    features_json <span class="op">=</span> json.dumps(features_dict)</span>
<span id="cb36-42"><a href="#cb36-42" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb36-43"><a href="#cb36-43" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Utilise le cache si disponible</span></span>
<span id="cb36-44"><a href="#cb36-44" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> predict_cached(features_hash, features_json)</span>
<span id="cb36-45"><a href="#cb36-45" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb36-46"><a href="#cb36-46" aria-hidden="true" tabindex="-1"></a>    logger.info(<span class="ss">f"Prediction - Hash: </span><span class="sc">{</span>features_hash[:<span class="dv">8</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb36-47"><a href="#cb36-47" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> result</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
<section id="sec-module7-checklist" class="level3" data-number="9.3">
<h3 data-number="9.3" class="anchored" data-anchor-id="sec-module7-checklist"><span class="header-section-number">9.3</span> Checklist de Production</h3>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Tip</span>Checklist Avant Production
</div>
</div>
<div class="callout-body-container callout-body">
<ul class="task-list">
<li><label><input type="checkbox">Tests unitaires avec coverage &gt; 80%</label></li>
<li><label><input type="checkbox">Tests d’integration</label></li>
<li><label><input type="checkbox">Load testing effectue</label></li>
<li><label><input type="checkbox">Monitoring configure</label></li>
<li><label><input type="checkbox">Alertes definies</label></li>
<li><label><input type="checkbox">Logs centralises</label></li>
<li><label><input type="checkbox">Documentation API complete</label></li>
<li><label><input type="checkbox">HTTPS active</label></li>
<li><label><input type="checkbox">Health checks fonctionnels</label></li>
<li><label><input type="checkbox">Auto-scaling teste</label></li>
<li><label><input type="checkbox">Variables d’environnement securisees</label></li>
<li><label><input type="checkbox">Budget Azure surveille</label></li>
</ul>
</div>
</div>
</section>
<section id="sec-module7-checkpoint" class="level3" data-number="9.4">
<h3 data-number="9.4" class="anchored" data-anchor-id="sec-module7-checkpoint"><span class="header-section-number">9.4</span> Checkpoint Final</h3>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Validation Module 7
</div>
</div>
<div class="callout-body-container callout-body">
<div style="margin-left: 20px; line-height: 1.8;">
<ul class="task-list">
<li><label><input type="checkbox">Cache de predictions implemente</label></li>
<li><label><input type="checkbox">Documentation complete</label></li>
<li><label><input type="checkbox">Tous les tests passent</label></li>
<li><label><input type="checkbox">Checklist de production verifiee</label></li>
</ul>
</div>
</div>
</div>
</section>
</section>
<section id="sec-nettoyage" class="level2" data-number="10">
<h2 data-number="10" class="anchored" data-anchor-id="sec-nettoyage"><span class="header-section-number">10</span> Nettoyage des Ressources Azure</h2>
<section id="sec-nettoyage-important" class="level3" data-number="10.1">
<h3 data-number="10.1" class="anchored" data-anchor-id="sec-nettoyage-important"><span class="header-section-number">10.1</span> IMPORTANT - Suppression pour Éviter les Coûts</h3>
<div class="callout callout-style-default callout-warning callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Warning</span>ATTENTION - À FAIRE À LA FIN DU WORKSHOP
</div>
</div>
<div class="callout-body-container callout-body">
<p>Pour éviter de consommer votre budget de 100$, supprimez toutes les ressources :</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb37"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Suppression du groupe de ressources (supprime tout)</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="ex">az</span> group delete <span class="at">--name</span> <span class="va">$RESOURCE_GROUP</span> <span class="at">--yes</span> <span class="at">--no-wait</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Verification</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a><span class="ex">az</span> group list <span class="at">--output</span> table</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Cette commande supprime : - Azure Container Registry - Azure Container Apps - Application Insights - Tous les logs et données</p>
<p><strong>Temps de suppression</strong> : 5-10 minutes</p>
</div>
</div>
</section>
<section id="sec-nettoyage-script" class="level3" data-number="10.2">
<h3 data-number="10.2" class="anchored" data-anchor-id="sec-nettoyage-script"><span class="header-section-number">10.2</span> Script de Nettoyage Automatique</h3>
<p>Créez <code>cleanup.sh</code> :</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb38"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="va">RESOURCE_GROUP</span><span class="op">=</span><span class="st">"rg-mlops-workshop"</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"=========================================="</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"Nettoyage des ressources Azure"</span></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"=========================================="</span></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a><span class="bu">read</span> <span class="at">-p</span> <span class="st">"Voulez-vous vraiment supprimer toutes les ressources ? (yes/no): "</span> <span class="va">confirm</span></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">[</span> <span class="st">"</span><span class="va">$confirm</span><span class="st">"</span> <span class="ot">!=</span> <span class="st">"yes"</span> <span class="bu">]</span><span class="kw">;</span> <span class="cf">then</span></span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">echo</span> <span class="st">"Operation annulee."</span></span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a>    <span class="bu">exit</span> 0</span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a><span class="cf">fi</span></span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"\nRessources a supprimer:"</span></span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a><span class="ex">az</span> resource list <span class="at">--resource-group</span> <span class="va">$RESOURCE_GROUP</span> <span class="at">--output</span> table</span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-19"><a href="#cb38-19" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"\nSuppression en cours..."</span></span>
<span id="cb38-20"><a href="#cb38-20" aria-hidden="true" tabindex="-1"></a><span class="ex">az</span> group delete <span class="at">--name</span> <span class="va">$RESOURCE_GROUP</span> <span class="at">--yes</span> <span class="at">--no-wait</span></span>
<span id="cb38-21"><a href="#cb38-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-22"><a href="#cb38-22" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"\nSuppression lancee (prend 5-10 minutes)"</span></span>
<span id="cb38-23"><a href="#cb38-23" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">"Verifiez sur : https://portal.azure.com"</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb39"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Rendre executable et lancer</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="fu">chmod</span> +x cleanup.sh</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="ex">./cleanup.sh</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</section>
</section>
<section id="sec-recapitulatif" class="level2" data-number="11">
<h2 data-number="11" class="anchored" data-anchor-id="sec-recapitulatif"><span class="header-section-number">11</span> Récapitulatif du Workshop</h2>
<section id="sec-recap-accompli" class="level3" data-number="11.1">
<h3 data-number="11.1" class="anchored" data-anchor-id="sec-recap-accompli"><span class="header-section-number">11.1</span> Ce que Vous Avez Accompli</h3>
<p>Félicitations ! Vous avez déployé un système MLOps complet :</p>
<p><strong>Architecture Finale :</strong></p>
<p><code>ML Training</code> → <code>FastAPI</code> → <code>Docker</code> → <code>Azure Container Registry</code> → <code>Azure Container Apps</code></p>
<p>↑ <code>GitHub Actions CI/CD</code></p>
<p>↑ <code>Application Insights Monitoring</code></p>
</section>
<section id="sec-recap-competences" class="level3" data-number="11.2">
<h3 data-number="11.2" class="anchored" data-anchor-id="sec-recap-competences"><span class="header-section-number">11.2</span> Compétences Acquises</h3>
<ol type="1">
<li><strong>Machine Learning</strong>
<ul>
<li>Entraînement d’un modèle Random Forest</li>
<li>Évaluation avec métriques appropriées</li>
<li>Tracking avec MLflow</li>
</ul></li>
<li><strong>Développement d’API</strong>
<ul>
<li>Création d’API REST avec FastAPI</li>
<li>Validation des données avec Pydantic</li>
<li>Documentation automatique</li>
</ul></li>
<li><strong>Conteneurisation</strong>
<ul>
<li>Dockerfiles optimisés</li>
<li>Bonnes pratiques de sécurité</li>
<li>Gestion des images</li>
</ul></li>
<li><strong>Cloud Azure</strong>
<ul>
<li>Azure Container Registry</li>
<li>Azure Container Apps</li>
<li>Application Insights</li>
</ul></li>
<li><strong>DevOps/MLOps</strong>
<ul>
<li>Pipelines CI/CD avec GitHub Actions</li>
<li>Tests automatisés</li>
<li>Déploiement continu</li>
</ul></li>
<li><strong>Monitoring et Maintenance</strong>
<ul>
<li>Logs centralisés</li>
<li>Métriques de performance</li>
<li>Détection de data drift</li>
</ul></li>
</ol>
</section>
<section id="sec-recap-points-cles" class="level3" data-number="11.3">
<h3 data-number="11.3" class="anchored" data-anchor-id="sec-recap-points-cles"><span class="header-section-number">11.3</span> Points Clés à Retenir</h3>
<div class="callout callout-style-default callout-important callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Important</span>Lecons Importantes
</div>
</div>
<div class="callout-body-container callout-body">
<ol type="1">
<li><strong>MLOps = DevOps + ML</strong> : Automatisation du cycle de vie complet</li>
<li><strong>Conteneurisation</strong> : Portabilité et reproductibilité</li>
<li><strong>Tests</strong> : Essentiels pour la fiabilité</li>
<li><strong>Monitoring</strong> : Indispensable en production</li>
<li><strong>Documentation</strong> : Facilite la collaboration</li>
<li><strong>Sécurité</strong> : À considérer dès le début</li>
<li><strong>Coûts</strong> : Toujours surveiller l’utilisation cloud</li>
</ol>
</div>
</div>
</section>
</section>
<section id="sec-faq" class="level2" data-number="12">
<h2 data-number="12" class="anchored" data-anchor-id="sec-faq"><span class="header-section-number">12</span> FAQ - Foire Aux Questions</h2>
<section id="sec-faq-techniques" class="level3" data-number="12.1">
<h3 data-number="12.1" class="anchored" data-anchor-id="sec-faq-techniques"><span class="header-section-number">12.1</span> Questions Techniques</h3>
<p><strong>Q1 : Mon API est lente, comment l’optimiser ?</strong></p>
<p><em>R :</em> Plusieurs options : - Activer le cache des prédictions - Utiliser des prédictions batch - Optimiser le modèle (quantization, pruning) - Augmenter les ressources CPU/RAM</p>
<p><strong>Q2 : Comment gérer plusieurs versions de modèles ?</strong></p>
<p><em>R :</em> Utilisez MLflow Model Registry et créez des endpoints différents (v1, v2).</p>
<p><strong>Q3 : Comment implémenter un rollback ?</strong></p>
<p><em>R :</em> Conservez les anciennes images Docker avec tags et utilisez :</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb40"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="ex">az</span> containerapp update <span class="dt">\</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">--name</span> <span class="va">$APP_NAME</span> <span class="dt">\</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">--resource-group</span> <span class="va">$RESOURCE_GROUP</span> <span class="dt">\</span></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">--image</span> <span class="va">$ACR_NAME</span>.azurecr.io/bank-churn-api:v1  <span class="co"># Version precedente</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p><strong>Q4 : Mon budget Azure est presque épuisé, que faire ?</strong></p>
<p><em>R :</em> - Mettre min-replicas à 0 - Utiliser des SKU Basic - Supprimer les ressources inutilisées - Activer les budgets alerts</p>
</section>
<section id="sec-faq-comprehension" class="level3" data-number="12.2">
<h3 data-number="12.2" class="anchored" data-anchor-id="sec-faq-comprehension"><span class="header-section-number">12.2</span> Questions de Compréhension</h3>
<p><strong>Q5 : Quelle est la différence entre Docker et Kubernetes ?</strong></p>
<p><em>R :</em> Docker conteneurise les applications, Kubernetes les orchestre (scaling, load balancing, self-healing).</p>
<p><strong>Q6 : Pourquoi utiliser FastAPI plutôt que Flask ?</strong></p>
<p><em>R :</em> FastAPI est plus rapide, avec validation automatique, documentation auto-générée, et support async natif.</p>
<p><strong>Q7 : Qu’est-ce que le data drift ?</strong></p>
<p><em>R :</em> Changement dans la distribution des données d’entrée par rapport aux données d’entraînement, pouvant dégrader les performances du modèle.</p>
</section>
</section>
<section id="sec-conclusion" class="level2" data-number="13">
<h2 data-number="13" class="anchored" data-anchor-id="sec-conclusion"><span class="header-section-number">13</span> Conclusion</h2>
<section id="sec-conclusion-felicitations" class="level3" data-number="13.1">
<h3 data-number="13.1" class="anchored" data-anchor-id="sec-conclusion-felicitations"><span class="header-section-number">13.1</span> Félicitations !</h3>
<p>Vous avez terminé ce workshop intensif de MLOps avec Azure. Vous avez construit un système complet de déploiement de modèle de Machine Learning en production, avec toutes les bonnes pratiques de l’industrie.</p>
</section>
<section id="sec-conclusion-next-steps" class="level3" data-number="13.2">
<h3 data-number="13.2" class="anchored" data-anchor-id="sec-conclusion-next-steps"><span class="header-section-number">13.2</span> Prochaines Étapes</h3>
<ol type="1">
<li><strong>Pratiquez</strong> : Refaites le workshop avec un dataset différent</li>
<li><strong>Partagez</strong> : Mettez votre projet sur GitHub</li>
<li><strong>Améliorez</strong> : Implémentez les fonctionnalités avancées</li>
<li><strong>Certifiez-vous</strong> : Préparez les certifications Azure</li>
</ol>
<hr>
<p><strong>Bon Apprentissage et Bon Déploiement !</strong></p>
<p><em>Ce guide vous a accompagné dans votre premier projet MLOps.<br>
Continuez à explorer, à apprendre et à innover.</em></p>
<hr>
<p><em>Version 1.0 - Novembre 2025</em><br>
<em>Workshop MLOps avec Azure</em></p>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
      const outerScaffold = trigger.parentElement.cloneNode(true);
      const codeEl = outerScaffold.querySelector('code');
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>